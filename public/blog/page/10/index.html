
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Nilenso Blog</title>
  <meta name="author" content="Nilenso">

  
  <meta name="description" content="
  
  
  
    
      
  
  
    
      Pow Over HTTPS
      
      
    
      
        










        
      
    
  


  I use Pow to manage ...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>

  
  <link rel="canonical" href="http://blog.nilenso.com/blog/page/10/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Nilenso Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>

  <!-- Typekit fonts -->
  <script type="text/javascript" src="//use.typekit.net/xgt4lgm.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43704022-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner">
</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  
</ul>
  
<header class="nilenso-header">
  <img class="header-logo-image left" src="/images/nilenso-200.png" />
  <a class="header-link logo-name" href="http://nilenso.com">nilenso</a>
  <a class="header-link right page-link rss-link" href="/atom.xml" title="subscribe via RSS"><img class="rss-link-image" src="/images/rss.png"></img></a>
  <a class="header-link page-link" href="/blog/archives">Archive</a>
  <a class="header-link page-link active" href="/">Blog</a>
</header>
<div class="clear"></div>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/07/11/pow-over-https/">Pow Over HTTPS</a></h1>
      
      
    
      <p class="meta">
        









<time datetime="2013-07-11T00:00:00-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I use <a href="http://pow.cx">Pow</a> to manage web servers on my development machine. It works pretty well.
To start my server, I just hit a URL like <code>http://surveyweb.dev</code>, which starts the server (if it isn&#8217;t running) and spins it down automatically in 5 minutes.</p>




<p>It doesn&#8217;t work over HTTPS by default; here&#8217;s how you get that done.</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gem install tunnels
</span></code></pre></td></tr></table></div></figure></p>

<p>This gem lets you route traffic from one port to another port.</p>




<p>We need to route traffic from port 443, to port 80 (where the Pow server runs).</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo tunnels 443 80
</span></code></pre></td></tr></table></div></figure></p>

<p>While the tunnel is open, I can access <code>https://surveyweb.dev</code> just fine.</p>




<p>Pow also has a feature where I can access my server from another machine on the LAN using a URL like <code>http://surveyweb.192.168.1.10.xip.io/</code> where <code>192.168.1.10</code> is the IP address of my machine. Even with the tunnel open, HTTPS doesn&#8217;t work for this URL.</p>




<p>We need to start another tunnel:</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo tunnels 192.168.1.10:443 127.0.0.1:80 <span class="c"># Replace 192.168.1.10 with your IP address</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>And now, both URLs work over HTTPS.</p>


<div class="author">
  <img src="http://nilenso.com/images/people/tim-200.png" style="width: 96px; height: 96;">
  <span style="position: absolute; padding: 32px 15px;">
    <i>Original post by <a href="http://twitter.com/timothyandrew">Timothy Andrew</a> - check out <a href="http://blog.timothyandrew.net/">Timothy&#39;s Blog</a></i>
  </span>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/07/10/using-roboguice-to-inject-views-into-a-pojo/">Using RoboGuice to Inject Views Into a POJO</a></h1>
      
      
    
      <p class="meta">
        









<time datetime="2013-07-10T00:00:00-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/roboguice/roboguice">RoboGuice</a> is great. It lets you get rid of code like:</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Button</span> <span class="n">mSignInButtonView</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mSignInButtonView</span> <span class="o">=</span> <span class="o">(</span><span class="n">Button</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">sign_in_button</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Instead, with a single line, RoboGuice will take care of injecting that view into your activity:</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginActivity</span> <span class="kd">extends</span> <span class="n">RoboActivity</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@InjectView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">sign_in_button</span><span class="o">)</span> <span class="n">Button</span> <span class="n">mSignInButtonView</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// I have a reference to mSignInButtonView here.</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Now we&#8217;re rewriting <a href="http://github.com/nilenso/ashoka-survey-mobile">ashoka-survey-mobile</a> as a layered <a href="(http://github.com/nilenso/ashoka-survey-mobile-native">native app</a>).
We have a LoginView (POJO) which needs references to views present on-screen. Normally, we would instantiate the POJO in the activity, and pass it all the views it needs.</p>




<p>But can we do this with RoboGuice? We can&#8217;t really use <code>@InjectView</code> in a POJO. It needs an Activity context.
The next best thing is to inject the activity into the POJO (RoboGuice is smart enough to inject the correct activity), and pick the views manually using <code>findViewById</code>.</p>




<p>So in the activity:</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginActivity</span> <span class="kd">extends</span> <span class="n">RoboActivity</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Inject</span> <span class="n">LoginView</span> <span class="n">loginView</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">loginView</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span> <span class="c1">// Need to manually build up the view references inside LoginView</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>and in <code>LoginView</code>:</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginView</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Inject</span> <span class="n">Activity</span> <span class="n">activity</span><span class="o">;</span> <span class="c1">// This gets injected with the correct instance of LoginActivity</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Button</span> <span class="n">buttonView</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">EditText</span> <span class="n">editText</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">buttonView</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">my_button</span><span class="o">);</span>
</span><span class='line'>        <span class="n">editText</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">my_edit_text</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>And then your POJO can manipulate the views that are on-screen as required.</p>


<div class="author">
  <img src="http://nilenso.com/images/people/tim-200.png" style="width: 96px; height: 96;">
  <span style="position: absolute; padding: 32px 15px;">
    <i>Original post by <a href="http://twitter.com/timothyandrew">Timothy Andrew</a> - check out <a href="http://blog.timothyandrew.net/">Timothy&#39;s Blog</a></i>
  </span>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/06/24/recursive-postgres-queries/">Recursive Postgres Queries</a></h1>
      
      
    
      <p class="meta">
        









<time datetime="2013-06-24T00:00:00-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Introduction</h3>




<p>At <a href="http://nilenso.com/">Nilenso</a>, I&#8217;m working on an (<a href="http://github.com/nilenso/ashoka-survey-web">open-source!</a>) app to design and conduct surveys.</p>




<p>Here&#8217;s a simple survey being designed:</p>




<p><a href="http://blog.timothyandrew.net/images/recursive-pg/survey-overview.png"><img src="http://blog.timothyandrew.net/images/recursive-pg/survey-overview.png" alt="Survey Builder Overview" /></a></p>




<p>Internally, this is represented as:</p>




<p><a href="http://blog.timothyandrew.net/images/recursive-pg/internal-survey-overview.png"><img src="http://blog.timothyandrew.net/images/recursive-pg/internal-survey-overview.png" alt="Survey Model Overview" /></a></p>




<p>A survey is made up of many <em>questions</em>. A number of questions can (optionally) be grouped together in a <em>category</em>. Our actual data model is a bit more complicated than this (sub-questions, especially), but let&#8217;s assume that we&#8217;re just working with questions and categories.</p>




<p>Here&#8217;s how we preserve the ordering of questions and categories in this survey.</p>




<p>Each question and category has an <code>order_number</code> field. It&#8217;s an integer that specifies the relative ordering of itself and its siblings.</p>




<p>For example, in this case,</p>




<p><a href="http://blog.timothyandrew.net/images/recursive-pg/order-number-overview.png"><img src="http://blog.timothyandrew.net/images/recursive-pg/order-number-overview.png" alt="Order Number Overview" /></a></p>




<p>the question <code>Bar</code> will have an <code>order_number</code> that is <em>less than</em> the order number of <code>Baz</code>.</p>




<p>This guarantees that the a category can fetch its sub-questions in the right order:</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># In category.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">sub_questions_in_order</span>
</span><span class='line'>  <span class="n">questions</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;order_number&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>In fact, this is how we fetch the entire survey at this point. Each category calls <code>sub_questions_in_order</code> on each of its children, and so on down the entire tree.</p>




<p>This gives us a depth-first ordering of this tree:</p>




<p><a href="http://blog.timothyandrew.net/images/recursive-pg/naive-order.png"><img src="http://blog.timothyandrew.net/images/recursive-pg/naive-order.png" alt="Naive Ordering" /></a></p>




<p>For large surveys with 5+ levels of nesting, and more than a hundred questions, this is pretty slow.</p>




<!-- more -->




<h3>Recursive Queries</h3>




<p>I&#8217;ve used gems like <a href="https://github.com/collectiveidea/awesome_nested_set"><code>awesome_nested_set</code></a> before, but as far as I could find, none of them supported fetching results across multiple models.</p>




<p>Then I stumbled on <a href="http://www.postgresql.org/docs/9.1/static/queries-with.html">a page</a> describing PostgreSQL&#8217;s support for recursive queries! That seemed perfect.</p>




<p>Let&#8217;s solve this particular problem using recursive queries. (My understanding of this is still very basic, so please don&#8217;t take my word for any of this)</p>




<p>To define a recursive Postgres query, we need to define an initial query, which is called the non-recursive term.</p>




<p>In our case, that would be the top level questions and categories.
Top level elements don&#8217;t have a parent category, so their <code>category_id</code> is <code>NULL</code>.</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">order_number</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span> <span class="n">category_id</span> <span class="k">FROM</span> <span class="n">questions</span>
</span><span class='line'>  <span class="k">WHERE</span> <span class="n">questions</span><span class="p">.</span><span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">AND</span> <span class="n">questions</span><span class="p">.</span><span class="n">category_id</span> <span class="k">IS</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">UNION</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">order_number</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span> <span class="n">category_id</span> <span class="k">FROM</span> <span class="n">categories</span>
</span><span class='line'>  <span class="k">WHERE</span> <span class="n">categories</span><span class="p">.</span><span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">AND</span> <span class="n">categories</span><span class="p">.</span><span class="n">category_id</span> <span class="k">IS</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>(That query, and all subsequent ones, assume that the survey we&#8217;re querying has id = 2)</p>




<p>This gives us the top-level elements.</p>




<p><a href="http://blog.timothyandrew.net/images/recursive-pg/top-level-elements-query.png"><img src="http://blog.timothyandrew.net/images/recursive-pg/top-level-elements-query.png" alt="Top-Level Queries" /></a></p>




<p>Now on to the recursive term. According to the Postgres docs:</p>




<p><a href="http://blog.timothyandrew.net/images/recursive-pg/steps.png"><img src="http://blog.timothyandrew.net/images/recursive-pg/steps.png" alt="Postgres Steps" /></a></p>




<p>Our recursive term simply has to find all the direct children of the elements fetched by the non-recursive term.</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">first_level_elements</span> <span class="k">AS</span> <span class="p">(</span>
</span><span class='line'>  <span class="c1">&ndash; Non-recursive term</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">order_number</span><span class="p">,</span> <span class="n">category_id</span> <span class="k">FROM</span> <span class="n">questions</span>
</span><span class='line'>      <span class="k">WHERE</span> <span class="n">questions</span><span class="p">.</span><span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">AND</span> <span class="n">questions</span><span class="p">.</span><span class="n">category_id</span> <span class="k">IS</span> <span class="k">NULL</span>
</span><span class='line'>    <span class="k">UNION</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">order_number</span><span class="p">,</span> <span class="n">category_id</span> <span class="k">FROM</span> <span class="n">categories</span>
</span><span class='line'>      <span class="k">WHERE</span> <span class="n">categories</span><span class="p">.</span><span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">AND</span> <span class="n">categories</span><span class="p">.</span><span class="n">category_id</span> <span class="k">IS</span> <span class="k">NULL</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="k">UNION</span>
</span><span class='line'>  <span class="c1">&ndash; Recursive Term</span>
</span><span class='line'>  <span class="k">SELECT</span> <span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">q</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="n">q</span><span class="p">.</span><span class="n">order_number</span><span class="p">,</span> <span class="n">q</span><span class="p">.</span><span class="n">category_id</span>
</span><span class='line'>  <span class="k">FROM</span> <span class="n">first_level_elements</span> <span class="n">fle</span><span class="p">,</span> <span class="n">questions</span> <span class="n">q</span>
</span><span class='line'>  <span class="k">WHERE</span> <span class="n">q</span><span class="p">.</span><span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">AND</span> <span class="n">q</span><span class="p">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="n">fle</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">first_level_elements</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>But wait. The recursive term is only fetching questions. What if the child of a first-level category is a category?
Postgres doesn&#8217;t let us reference the non-recursive term more than once. So doing a <code>UNION</code> of categories and questions is out.
We have to be a little creative here:</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">first_level_elements</span> <span class="k">AS</span> <span class="p">(</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">order_number</span><span class="p">,</span> <span class="n">category_id</span> <span class="k">FROM</span> <span class="n">questions</span>
</span><span class='line'>      <span class="k">WHERE</span> <span class="n">questions</span><span class="p">.</span><span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">AND</span> <span class="n">questions</span><span class="p">.</span><span class="n">category_id</span> <span class="k">IS</span> <span class="k">NULL</span>
</span><span class='line'>    <span class="k">UNION</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">order_number</span><span class="p">,</span> <span class="n">category_id</span> <span class="k">FROM</span> <span class="n">categories</span>
</span><span class='line'>      <span class="k">WHERE</span> <span class="n">categories</span><span class="p">.</span><span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">AND</span> <span class="n">categories</span><span class="p">.</span><span class="n">category_id</span> <span class="k">IS</span> <span class="k">NULL</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="k">UNION</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="n">e</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">order_number</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">category_id</span>
</span><span class='line'>      <span class="k">FROM</span>
</span><span class='line'>      <span class="p">(</span>
</span><span class='line'>        <span class="c1">&ndash; Fetch questions AND categories</span>
</span><span class='line'>        <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">order_number</span><span class="p">,</span> <span class="n">category_id</span> <span class="k">FROM</span> <span class="n">questions</span> <span class="k">WHERE</span> <span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>        <span class="k">UNION</span>
</span><span class='line'>        <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">order_number</span><span class="p">,</span> <span class="n">category_id</span> <span class="k">FROM</span> <span class="n">categories</span> <span class="k">WHERE</span> <span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>      <span class="p">)</span> <span class="n">e</span><span class="p">,</span> <span class="n">first_level_elements</span> <span class="n">fle</span>
</span><span class='line'>      <span class="k">WHERE</span> <span class="n">e</span><span class="p">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="n">fle</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">first_level_elements</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>We perform a <code>UNION</code> of categories and questions <em>before</em> joining it with the non-recursive term.</p>




<p>This yields all the survey elements:</p>




<p><a href="http://blog.timothyandrew.net/images/recursive-pg/all-elements-without-order-query.png"><img src="http://blog.timothyandrew.net/images/recursive-pg/all-elements-without-order-query.png" alt="Query without ordering" /></a></p>




<p>Unfortunately, it looks like the ordering is way off.</p>




<h3>Ordering a Recursive Query</h3>




<p>The problem is that since we&#8217;re effectively <em>appending</em> second-level elements to first-level elements, we&#8217;re effectively performing a <a href="https://en.wikipedia.org/wiki/Breadth-first_search"><em>breadth-first search</em></a> instead of a <a href="http://en.wikipedia.org/wiki/Depth-first_search"><em>depth-first search</em></a>.</p>




<p>How can we correct that?</p>




<p>Postgres has <a href="http://www.postgresql.org/docs/9.1/static/arrays.html">arrays</a> that can be built during a query.</p>




<p>Let&#8217;s build an array of order numbers for each element that we fetch. Let&#8217;s call this the <code>path</code>. The <code>path</code> for an element is:</p>




<blockquote><p>the path of it&#8217;s parent category (if one exists) + its own order_number</p></blockquote>




<p>If we sort the final result by <code>path</code>, we&#8217;ve converted it into a depth-first search!</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">first_level_elements</span> <span class="k">AS</span> <span class="p">(</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">category_id</span><span class="p">,</span> <span class="nb">array</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="k">AS</span> <span class="n">path</span> <span class="k">FROM</span> <span class="n">questions</span>
</span><span class='line'>      <span class="k">WHERE</span> <span class="n">questions</span><span class="p">.</span><span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">AND</span> <span class="n">questions</span><span class="p">.</span><span class="n">category_id</span> <span class="k">IS</span> <span class="k">NULL</span>
</span><span class='line'>    <span class="k">UNION</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">category_id</span><span class="p">,</span> <span class="nb">array</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="k">AS</span> <span class="n">path</span> <span class="k">FROM</span> <span class="n">categories</span>
</span><span class='line'>      <span class="k">WHERE</span> <span class="n">categories</span><span class="p">.</span><span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">AND</span> <span class="n">categories</span><span class="p">.</span><span class="n">category_id</span> <span class="k">IS</span> <span class="k">NULL</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="k">UNION</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="n">e</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">category_id</span><span class="p">,</span> <span class="p">(</span><span class="n">fle</span><span class="p">.</span><span class="n">path</span> <span class="o">||</span> <span class="n">e</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>      <span class="k">FROM</span>
</span><span class='line'>      <span class="p">(</span>
</span><span class='line'>        <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">category_id</span><span class="p">,</span> <span class="n">order_number</span> <span class="k">FROM</span> <span class="n">questions</span> <span class="k">WHERE</span> <span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>        <span class="k">UNION</span>
</span><span class='line'>        <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">category_id</span><span class="p">,</span> <span class="n">order_number</span> <span class="k">FROM</span> <span class="n">categories</span> <span class="k">WHERE</span> <span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>      <span class="p">)</span> <span class="n">e</span><span class="p">,</span> <span class="n">first_level_elements</span> <span class="n">fle</span>
</span><span class='line'>      <span class="k">WHERE</span> <span class="n">e</span><span class="p">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="n">fle</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">first_level_elements</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">path</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><a href="http://blog.timothyandrew.net/images/recursive-pg/almost.png"><img src="http://blog.timothyandrew.net/images/recursive-pg/almost.png" alt="Query with duplicate" /></a></p>




<p>That&#8217;s <em>almost</em> right. There are two entries for <em>What&#8217;s your favourite song?</em></p>




<p>This is happening because when we do an ID comparison to look for children:</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">WHERE</span> <span class="n">e</span><span class="p">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="n">fle</span><span class="p">.</span><span class="n">id</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><code>fle</code> contains both questions and categories. But we want this to match only categories (because questions can&#8217;t have children).</p>




<p>Let&#8217;s hard-code a type into each of these queries, so that we don&#8217;t try and check for children of a question:</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">first_level_elements</span> <span class="k">AS</span> <span class="p">(</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">category_id</span><span class="p">,</span> <span class="s1">&#39;questions&#39;</span> <span class="k">as</span> <span class="k">type</span><span class="p">,</span> <span class="nb">array</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="k">AS</span> <span class="n">path</span> <span class="k">FROM</span> <span class="n">questions</span>
</span><span class='line'>      <span class="k">WHERE</span> <span class="n">questions</span><span class="p">.</span><span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">AND</span> <span class="n">questions</span><span class="p">.</span><span class="n">category_id</span> <span class="k">IS</span> <span class="k">NULL</span>
</span><span class='line'>    <span class="k">UNION</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">category_id</span><span class="p">,</span> <span class="s1">&#39;categories&#39;</span> <span class="k">as</span> <span class="k">type</span><span class="p">,</span> <span class="nb">array</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="k">AS</span> <span class="n">path</span> <span class="k">FROM</span> <span class="n">categories</span>
</span><span class='line'>      <span class="k">WHERE</span> <span class="n">categories</span><span class="p">.</span><span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">AND</span> <span class="n">categories</span><span class="p">.</span><span class="n">category_id</span> <span class="k">IS</span> <span class="k">NULL</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="k">UNION</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="n">e</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">category_id</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="k">type</span><span class="p">,</span> <span class="p">(</span><span class="n">fle</span><span class="p">.</span><span class="n">path</span> <span class="o">||</span> <span class="n">e</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>      <span class="k">FROM</span>
</span><span class='line'>      <span class="p">(</span>
</span><span class='line'>        <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">category_id</span><span class="p">,</span> <span class="s1">&#39;questions&#39;</span> <span class="k">as</span> <span class="k">type</span><span class="p">,</span> <span class="n">order_number</span> <span class="k">FROM</span> <span class="n">questions</span> <span class="k">WHERE</span> <span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>        <span class="k">UNION</span>
</span><span class='line'>        <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">category_id</span><span class="p">,</span> <span class="s1">&#39;categories&#39;</span> <span class="k">as</span> <span class="k">type</span><span class="p">,</span> <span class="n">order_number</span> <span class="k">FROM</span> <span class="n">categories</span> <span class="k">WHERE</span> <span class="n">survey_id</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>      <span class="p">)</span> <span class="n">e</span><span class="p">,</span> <span class="n">first_level_elements</span> <span class="n">fle</span>
</span><span class='line'>      <span class="c1">&ndash; Look for children only if the type is &#39;categories&#39;</span>
</span><span class='line'>      <span class="k">WHERE</span> <span class="n">e</span><span class="p">.</span><span class="n">category_id</span> <span class="o">=</span> <span class="n">fle</span><span class="p">.</span><span class="n">id</span> <span class="k">AND</span> <span class="n">fle</span><span class="p">.</span><span class="k">type</span> <span class="o">=</span> <span class="s1">&#39;categories&#39;</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">first_level_elements</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">path</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><a href="http://blog.timothyandrew.net/images/recursive-pg/final.png"><img src="http://blog.timothyandrew.net/images/recursive-pg/final.png" alt="Final Query" /></a></p>




<p>That seems about right. We&#8217;re done here.</p>




<p>Let&#8217;s see how much of a performance boost this gives us.</p>




<h3>Performance</h3>




<p>Using this script (after creating a survey from the UI), I generated 10 sub-question chains; each 6 levels deep.</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">survey</span> <span class="o">=</span> <span class="no">Survey</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</span><span class='line'><span class="mi">10</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">category</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:category</span><span class="p">,</span> <span class="ss">:survey</span> <span class="o">=&gt;</span> <span class="n">survey</span><span class="p">)</span>
</span><span class='line'>  <span class="mi">6</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">category</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:category</span><span class="p">,</span> <span class="ss">:category</span> <span class="o">=&gt;</span> <span class="n">category</span><span class="p">,</span> <span class="ss">:survey</span> <span class="o">=&gt;</span> <span class="n">survey</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:single_line_question</span><span class="p">,</span> <span class="ss">:category_id</span> <span class="o">=&gt;</span> <span class="n">category</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">:survey_id</span> <span class="o">=&gt;</span> <span class="n">survey</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Each chain looks like this:</p>




<p><a href="http://blog.timothyandrew.net/images/recursive-pg/chain.png"><img src="http://blog.timothyandrew.net/images/recursive-pg/chain.png" alt="Sub-question Chain" /></a></p>




<p>Let&#8217;s see if recursive queries are faster.</p>


<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">ms</span> <span class="p">{</span> <span class="mi">5</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">Survey</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">sub_questions_using_recursive_queries</span> <span class="p">}}</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="mi">36</span><span class="o">.</span><span class="mi">839999999999996</span>
</span><span class='line'>
</span><span class='line'><span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">ms</span> <span class="p">{</span> <span class="mi">5</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">Survey</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">sub_questions_in_order</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="mi">1145</span><span class="o">.</span><span class="mi">1309999999999</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>31x faster? Not bad.</p>




<p><a href="http://blog.timothyandrew.net/images/recursive-pg/not-bad.jpg"><img src="http://blog.timothyandrew.net/images/recursive-pg/not-bad.jpg" alt="Not bad" /></a></p>


<div class="author">
  <img src="http://nilenso.com/images/people/tim-200.png" style="width: 96px; height: 96;">
  <span style="position: absolute; padding: 32px 15px;">
    <i>Original post by <a href="http://twitter.com/timothyandrew">Timothy Andrew</a> - check out <a href="http://blog.timothyandrew.net/">Timothy&#39;s Blog</a></i>
  </span>
</div>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/11">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/9">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>A little something about me.</p>
</section>
Included file 'custom/asides/subscribe.html' not found in _includes directory<section>
  <h1>Popular Posts</h1>
  <ul id="recent_posts">
    
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/10/01/writing-a-simple-rest-web-service-in-purescript-p/">Writing a Simple REST Web Service in PureScript - Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/29/writing-a-simple-rest-web-service-in-purescript-p/">Writing a Simple REST Web Service in PureScript - Part 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/12/gunak-designing-with-the-indian-government/">Gunak — Designing with the Indian Government</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/05/05/designing-for-rural-india-part-1/">Designing for Rural India — Part 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/04/06/black-mirror-or-a-review-of-the-review-process-at/">Black Mirror*, or a review of the review process at a software co-operative</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/nilenso">@nilenso</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'nilenso',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section id="twitter">
  <h1 class="tweets">Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("nilenso", , );
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <p>Follow <a href="http://twitter.com/nilenso">@nilenso</a></p>
  
</section>





  
</aside>

    </div>
  </div>
  <div class="sidebar">
    <p class="sidebar-content">
      <a href="http://nilenso.com">nilenso</a> is an employee-owned software cooperative based out of Bangalore, India.
    </p>
    <p class="sidebar-content">
      We practice test driven development and continuous delivery, and love working with Clojure and Ruby on Rails.
    </p>
    <p class="sidebar-content">
      This blog is a showcase of our growth as a consultancy, a product company and generally curious beings.
      Get in touch with us at <a href="mailto:hello@nilenso.com">hello@nilenso.com</a>.
    </p>
  </div>
</body>
<div class="footer">
  <div class="section-content contact-info">
    <p class="contact-phone-number">
      <a class="contact-link email-link" href="mailto:hello@nilenso.com">hello@nilenso.com</a>
      <a class="contact-link contact-social-link" href="http://twitter.com/nilenso">@nilenso</a>
      <a class="contact-link contact-social-link" href="http://github.com/nilenso">github.com/nilenso</a>
      <a class="contact-link" href="tel:+918040937123">+91 80 4093 7123</a>
     </p>
    <p class="contact-address">Nilenso Software LLP, #105, 10th Cross, Indiranagar Stage 1, Bangalore, India, 560038</p>
  </div>
</div>









  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</html>
