
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Nilenso Blog</title>
  <meta name="author" content="Nilenso">

  
  <meta name="description" content="
  
  
  
    
      
  
  
    
      Finances in an Employee-Owned Technology Co-operative
      
      
    
      
        










        
...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>

  
  <link rel="canonical" href="http://blog.nilenso.com/blog/page/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Nilenso Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>

  <!-- Typekit fonts -->
  <script type="text/javascript" src="//use.typekit.net/xgt4lgm.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43704022-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner">
</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  
</ul>
  
<header class="nilenso-header">
  <img class="header-logo-image left" src="/images/nilenso-200.png" />
  <a class="header-link logo-name" href="http://nilenso.com">nilenso</a>
  <a class="header-link right page-link rss-link" href="/atom.xml" title="subscribe via RSS"><img class="rss-link-image" src="/images/rss.png"></img></a>
  <a class="header-link page-link" href="/blog/archives">Archive</a>
  <a class="header-link page-link active" href="/">Blog</a>
</header>
<div class="clear"></div>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2018/05/23/finances-in-an-employee-owned-technology-co-opera/">Finances in an Employee-Owned Technology Co-operative</a></h1>
      
      
    
      <p class="meta">
        









<time datetime="2018-05-23T00:00:00-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you are not already familiar with <a href="https://nilenso.com">nilenso</a>, I apologize. This article may not make any sense to you. Requested as an opinion piece in reply to an internal email on salaries, it hinges on a lot of context.</p>


<p>You may find that context interesting.</p>


<ul><li>YourStory: <a href="https://yourstory.com/2017/02/nilenso-sofware-cooperative/">India’s first software co-operative</a></li><li><a href="https://yourstory.com/2017/02/nilenso-sofware-cooperative/">Huh? A Software Cooperative?</a> — an introduction</li><li><a href="https://blog.nilenso.com/blog/2015/06/30/how-to-co-op-salaries-reviews/">How to Co-op: Salaries and Reviews</a></li><li><a href="https://blog.nilenso.com/blog/2016/05/16/i-have-cramps/">“I have cramps.”</a> — introducing our menstrual leave policy</li><li><a href="https://blog.nilenso.com/blog/2017/02/14/nilenso-policies-by-the-people-for-the-people/">nilenso policies</a> — democratic corporate benefits</li><li><a href="https://blog.nilenso.com/blog/2017/04/06/black-mirror-or-a-review-of-the-review-process-at/">nilenso reviews</a> — how do we evaluate one another?</li><li><a href="https://blog.nilenso.com/blog/archives/">blog archive</a> — the rest of the articles we’ve written</li></ul>


<p>The email which spawned this discussion was from a new employee, suggesting that we raise salaries. We discuss such organizational and infrastructural changes on occasion (not often) and an open conversation is welcome.</p>


<p>However, as I’m leaving nilenso in July, it felt worthwhile to capture what would otherwise be a one-time, long-winded email to nilenso’s <em>existing</em> staff and transform that into an article which could capture one founding member’s opinion of what nilenso is, for all future staff — and other fans of Employee-owned Co-operatives—who would care to read it.</p>


<h3>On Salaries</h3>


<p>The original email had a fairly simple 3-part structure.</p>


<p><strong>First: How much can we pay?</strong> …without compromising on organizational goals like maintaining a rainy-day cash buffer and financing experimental new ventures?</p>


<p><strong>Second, a declaration of our rates &amp; salaries.</strong> Highlighted is the delta between the two. Our rates vary a lot from project to project, but for the sake of example, imagine our rates average to $100/hour. (100 is a nice round number.) At $100/hour, our rates were high for Indian software consultancies, but not astronomical. A napkin calculation roughs $100/hour to over $100,000/year in revenue. Historically, very senior people at nilenso made about half this revenue figure as salary.</p>


<blockquote>[F]or people with more experience and established reputation, there is an incentive to break away and start their own business so that they can pocket the difference.</blockquote>


<p>(All quotes are from the aforementioned email.)</p>


<p><strong>Third and last, a spectrum of starting salaries.</strong> These were listed for college grads of reputable Indian universities, such as NIT and IIT. Paymasters near the top included Uber and Goldman Sachs. Near the bottom were Samsung and American Express.</p>


<blockquote>Some of the people I know from college are very good programmers and I’ll have a very hard [time] convincing them to join Nilenso [sic], because the difference between our salaries and the industry “standard” is too large.</blockquote>


<p>….</p>


<blockquote>[M]ost of our clients can pay pretty high salaries. From their perspective it isn’t an unreasonable strategy to hire a bunch of folks from nilenso instead of negotiating our high rates</blockquote>


<p>It is possible this argument doesn’t seem irrational in isolation, so let’s break it down part by part. From hereon out, please automatically prefix any declaration I make with “as of this writing.”</p>


<h3>Part 3: A unicorn pissing contest</h3>


<p>Let’s start from the end, since—tellingly—the actionable question was actually posed first.</p>


<p>There are a number of reasons our clients have not frequently hired our staff away. First, and most strictly, some contracts we sign have a two-way no-hire clause. In these cases, our clients cannot hire our employees and we cannot hire theirs. However, just because the contract does not forbid poaching does not make it a good idea. Our preferred engagement model is a long-term, cooperative and collaborative relationship; if either side starts yanking the other entity’s employees, that’s a great way to either poison the engagement.</p>


<p>In addition to all of this, however, there is sustainability at stake. As global consultancies go, nilenso is very small and very good. The author of the email is our 20th co-op member. Unless a client is very comfortable burning bridges, hiring two of our staff today trims our numbers by a non-trivial 10%. We don’t work with cannibal business owners.</p>


<p>That isn’t to say no one has ever left nilenso this way. If it happens, we simply hope that person takes their decision very seriously. Some of our alumni left to join past clients — and we wished them well.</p>


<p>People do not work at nilenso to get rich.</p>


<p>People work here because they believe in something. As we’ll see, “something” isn’t defined by some manifesto or mission statement. The “something” isn’t likely to be found elsewhere and it’s even less likely to be the same for two different people at nilenso. “Something” probably isn’t a single thing within the mind of a single person. “Something” is fractured and ever-changing. Each fractured shard is at any given time either a hallucination manifesting in action or a miscalculation fading to black.</p>


<p>As complex as The Somethings are, there has thus far been a few consistent threads. One? T<strong>echnical excellence</strong>. A potential client from Vietnam recently asked “<em>what is the ratio of fresh grads you hire to senior developers?</em>” Though it may not appear so on the surface, the idea that “<em>I’ll have a very hard [time] convincing [people I know from college] to join</em>” stems from the very same misconception.</p>


<p>nilenso is not a leveraged consultancy.</p>


<p>The misconception is that nilenso desires to behave as other consultancies by “leveraging”** their weakest employees (read: fresh grads) and charging the highest possible rate by inflating them with as few “senior”** developers as possible. The misconception is not unfounded. Most consultancies operate this way. We do not.</p>


<p>**<em> industry terminology, not mine</em></p>


<p>Convincing college grads to apply to nilenso is not a problem we’d like to solve. We have college grads begging us for internships and offering to work for free.</p>


<p><strong>We do not want to hire college grads.</strong></p>


<p>When our clients hire nilenso, we don’t want them satisfied. <em>We want them elated</em>. With one or two exceptions, our most junior developers always have multiple years of experience. They joined us because they couldn’t find their Something anywhere else in the industry. Not only has a college grad not, by definition, owned her own software in production — she hasn’t had an opportunity to go look for Something yet. <em>Go searching first—and learn to build and deploy software while you’re at it. </em>Maybe she’ll find her Something. If she doesn’t, she can join a company like ours.</p>


<p>We are not Uber or Goldman Sachs. We don’t <a href="https://en.wikipedia.org/wiki/Uber#Sexual_harassment_allegations_and_management_shakeup_(2017)">treat our female colleagues like shit</a>, we don’t have an <a href="https://en.wikipedia.org/wiki/Uber#Workplace_culture">“asshole culture”</a>, we haven’t <a href="https://en.wikipedia.org/wiki/Uber#2014_reviews_by_the_Better_Business_Bureau">received a failing grade from the Better Business Bureau</a>, nor do we have a list of “controversies and legal issues” <a href="https://en.wikipedia.org/wiki/Goldman_Sachs#Controversies_and_legal_issues">as long as your arm</a>.</p>


<p>Some of us have worked for companies like these and we have done everything in our power to <em>prevent</em> nilenso from becoming such a company. We don’t need revenue in the billions to behave this way but racing to compete salaries with such companies does us zero favours in that arena.</p>


<p>There is perhaps no better way for a college kid to learn the value of a company like nilenso than to experience a cesspool like Uber firsthand for a couple years. Not that I recommend the grads start their search there, mind you.</p>


<h3>Part 2: Where is all this magical money coming from?</h3>


<p>In “Part 3”, when I say that nilenso is “very small and very good” I mean that from the bottom of my heart. We are <em>very</em> good. We don’t fantasize about our clients paying us $100/hour — our current clients pay us this because we are <em>worth it</em>. Our first month with every new client is always evaluatory (we even did a 3-month evaluation period once). This is an opportunity for our clients to fire us if they find us too expensive and for us to fire them if we find the relationship isn’t productive.</p>


<p>Why are our developers worth well over $10,000 USD per month?</p>


<p>There is a watermark here. One can calculate the watermark in a number of ways. The first and most obvious is: How many people at nilenso have ever been paid $120,000/year or higher in any country? <strong>Two.</strong> So that probably puts the watermark too high. How many people at nilenso could be paid $120,000/year (roughly 77 lakh rupees) today — specifically in Bangalore? <strong>Three.</strong></p>


<p>These numbers are clearly too low. The entire value of our company does not hinge on two or three people. But these are the only objective numbers we have on this axis. If we wanted to reach for a subjective number, we could say the watermark exists beneath anyone to whom our rates can be actively attributed. I would say these people number <strong>seven</strong>.</p>


<p>Seven of twenty active knowledge workers does not mean we “leverage” (ugh, that word) the other thirteen. Other folks are very close or arguably cross this watermark. But every team has a natural pecking order (a hierarchy drawn in a straight line, whether you draw it with a pen or with your mind) and wherever we assume this watermark to be, our value to our customers is more than the sum of the parts.</p>


<p>The flaw in the “wow, we make so much money!” argument is that no matter where you place this watermark, you must actively acknowledge from where this value is generated: above the watermark. If there is an argument to be made for altering the salary curve to reflect this, that alteration always implies an inflection point <em>at the watermark</em>. People above the watermark should be paid more. People below the watermark should be paid less. Your financial goals as an employee of such a company are dictated by your ability to cross the watermark and stay above it.</p>


<p>That doesn’t sound like a place I’d like to work.</p>


<p>I’m guessing the author of the original email feels the same way. Being our most junior staff member means starting at the very bottom of this curve and a search for the source of a consultancy’s value is always upward-facing. That’s a big hill to climb and it’s a lot more likely that crossing the watermark will involve nilenso growing from 20 to 40 rather than the most junior employee leapfrogging over 10 other people. We grow slowly on purpose — and it’s not to keep junior people at the bottom of the pay scale.</p>


<p>We would rather grow <em>inside</em>. We want our most junior staff to become more senior not by stacking themselves on top of new junior people but by perfecting their execution.</p>


<blockquote>[F]or people with more experience and established reputation, there is an incentive to break away and start their own business so that they can pocket the difference.</blockquote>


<p>No one at nilenso has ever done this. Why not?</p>


<h3>Part 1: Where does all this money go?</h3>


<p>Now we get to the juicy bits. The interesting question is not “how much can we pay?” <em>at all</em>. If someone wants to double her salary she can very easily do so today and nilenso is entirely unequipped to deal with that except to wish her the best with her new job.</p>


<p><strong>People do not work at nilenso to get rich.</strong></p>


<p>People work at nilenso to find… something. Something. What is that Something? To answer this, we must ask: What is nilenso? This is the interesting question.</p>


<p>Nilenso Software LLP is, today, a co-op; nilenso is self-hosted. It is written in a homoiconic language. It is self-referential. It is self-describing. The specification is the paper the specification is written on. And while none of these qualities are the Something we were all after, they are the qualities which equip us to do <em>anything we want</em> with the company. We are uninhibited in finding our Somethings if we never need to beg for VC money, never need to give up control, and never need to grow before we’re ready.</p>


<p>“Anything we want” can include bumping our salaries by 10% or 50%. It can include handing out bonuses. It can include democratically deciding we want to execute across-the-board pay cuts. But these are all pretty boring axes to manipulate the business. You don’t have to work at a co-op (and therefore run it) for very long to realize the the classic definitions of success are mind-numbingly boring… albeit always tempting.</p>


<p>Anything we want? Here is a far more interesting list:</p>


<ul><li>helping parents raise children in the modern world</li><li>protect privacy as a fundamental right</li><li>fuel our office with solar panels</li><li>make the activity of building free software a work of pride, again</li><li>liberate the data sciences with truly open data</li><li>globally redefine what constitutes a “normal workplace”</li><li>what do you want to do? does it take money to do it? (hint: yes)</li></ul>


<p>Every rupee we keep inside nilenso, invest as nilenso, or spend as nilenso pushes us further toward a collective activity, a collective vision. Every rupee we divide and distribute, 5 paise per co-op member, is a step away from a collective vision. The farthest we can go in this direction is to distribute everything: nilenso saves nothing, invests nothing, and builds nothing. Well before that stage, nilenso becomes an Umbrella Consultancy and we are nilenso in name only… another army of contractors with a brand attached and a few rupees saved every month to pay the water bill.</p>


<p>It is entirely valid for the collective vision of nilenso to be “we don’t want to have a collective vision” but once that is decided, there is no going back. If you want to become a software product company (as we attempted with <a href="https://relay-chat.com">Relay</a> and previously attempted with <a href="https://github.com/nilenso/kulu">Kulu</a>), an electric rickshaw taxi service (a business model we have seriously considered), or a cafe (a business model we have jokingly considered)… you can’t. You get to go back to Square One, where we were when we incorporated nilenso in 2013. But you get to go back with no money and no way to compete on salaries but to rebuild a vision from scratch.</p>


<p>Good luck. It wasn’t easy the first time.</p>


<h3>Epilogue</h3>


<p>There is no easy way to think about the future regarding corporate or personal finances and arrive at novel conclusions. Follow Steve Jobs’ advice, drop enough acid, and you may. But you are still unlikely to execute based on these conclusions when you are sober on Monday. Such contemplations demand an entire suite of thought exercises. This is my favourite:</p>


<p>Flip the <em>Five Whys</em> exercise around and you have the <em>And Then What?</em> exercise.</p>


<p>Once you are rich, then what? Once you have solved the original problem, then what? Once you have solved an entire category of problems, then what? Once you have taught others to do it, then what?</p>


<p>And then what?</p>


<p>And then what?</p>


<p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=a18a2976f0d7" width="1" height="1"><div class="author">
  <img src="http://nilenso.com/images/people/steven2-200.png" style="width: 96px; height: 96;">
  <span style="position: absolute; padding: 32px 15px;">
    <i>Original post by <a href="http://twitter.com/deobald">Steven Deobald</a> - check out <a href="https://medium.com/@deobald?source=rss-f6b24d2dc678------2">Stories by Steven Deobald on Medium</a></i>
  </span>
</div></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2018/04/09/designing-for-open-source-software/">Designing for Open Source Software</a></h1>
      
      
    
      <p class="meta">
        









<time datetime="2018-04-09T00:00:00-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>Mattermost → Relay</h4>


<p>When you hear the words “open source” attached to a product, what image comes to mind? Do you imagine an office full of designers obsessing over every little pixel? Or do you imagine an army of alpha-nerds piecing together a slap-dash knockoff of some proprietary software?</p>


<p>We all believe open source software is badly designed because, historically, it was. (#NotAllOpenSourceSoftware)</p>


<p>Thirty years ago, in 1988, the very concept of a license or design language for software was far beyond the average person. A decade later, everything was still awful. Software barely worked. Your PC definitely had a virus on it. HTML had a &lt;blink&gt; tag. Installing Linux required weeks of patience and belief in oneself — the kind of conviction I would need to train for a marathon. If there is one canonical failure we can promote as the poster child of this dark era, it is OpenOffice. Or StarOffice or LibreOffice or Apache OpenOffice or OOo or AOO or whatever name you might know it by. When the very <em>name</em> of the product is this broken it’s unlikely to succeed as a brand.</p>


<p>Fast forward ten more years. As of 2008, Firefox was eating Microsoft’s lunch. Firefox was open source, fast, and standards-compliant. It was easy to like Firefox. But we didn’t like Firefox. We <strong>loved</strong> Firefox. Firefox had a brand before it was Firefox. A brand isn’t a snappy name and a cute logo. Your product is your brand and your product is dictated by its design.</p>


<p><figure><img alt="" src="https://cdn-images-1.medium.com/max/400/1*Mbzpzkw4uraKcHuYgVnp_g.png" /><figcaption>Image from <a href="http://www.lowter.com/blogs/2008/6/21/firefox-3">Lowter</a></figcaption></figure><p>In 2018, user expectations demand that design asymptotically approach perfection: your product better be open, compatible, clean, fast, and powerful. When nilenso first made the move <a href="https://medium.com/@deobald/we-created-relay-by-escaping-slack-aedf0579a65f">from Slack to Mattermost</a>, we kept all of this in mind. From our very first deployment of Mattermost it felt <em>whole</em>. We chose Mattermost because it was so very close to the design we wanted, we knew we could help bring it the rest of the way.</p><h3>The beginning</h3><p>The design problems that currently exist with Mattermost aren’t just visual but interaction and experience related. One of the first issues we took up was adding infinite scroll to the channel history. We couldn’t fathom why users should manually click to load every page of history. <a href="https://github.com/mattermost/mattermost-webapp/pull/941">So we fixed it</a>!</p><p>In the not-too-distant future we will add all the little nuanced details which transform Relay into software you absolutely <strong>love</strong>. At the moment, however, our aim is to solve the obvious problems our users have with the Mattermost/Relay experience. Like infinite scroll, these are the problems that left our early users shouting at us “ugh… how have you not fixed this yet?!”</p><p>Such problems stem from the pains caused by inconsistencies and visual discrepancies which hamper usability. It is surprising to many how quickly these seemingly small issues amount to death by a thousand papercuts. It is equally surprising how quickly software becomes a joy to use once you get the basics right.</p><p>We’ll start with the basics — icons and fonts — and then move on to the specifics of how we redesigned Mattermost as Relay, piece by piece.</p><h3>Icons</h3><p><a href="https://medium.com/@deobald/we-created-relay-by-escaping-slack-aedf0579a65f">When we moved from Slack to Mattermost</a> the difference in icons used was stark. All icons used in Mattermost were inconsistent with respect to weights. They were standing out of the interface rather than blending in.</p><p>After further digging, we realised that Mattermost uses the free version of <a href="https://fontawesome.com/icons">Font Awesome</a>. Don’t get me wrong, I love the guys at Font Awesome; I even backed their kickstarter. But not all icons being available in the free weights (regular &amp; solid) is quite a bummer.</p><p>We had three rules for selecting an icon set:</p><ul><li>Icons <strong>must</strong> be open source</li><li>Icons need to be extensive</li><li>Icons need to be available in different styles (line and solid)</li></ul><blockquote>Allow me to interrupt with an aside. Technically, it is <em>possible</em> for us to build commercial artefacts into the Relay client by keeping them out of the source tree, even though Relay is AGPL3-licensed (as a derivative of the <a href="https://github.com/mattermost/mattermost-webapp">mattermost-webapp</a>). Why, then, do we feel it is essential that the icons be open source? Relay lives at the intersection of <a href="https://www.fsf.org/about/what-is-free-software">the principles of Free Software</a> and <a href="https://opensource.org/licenses/AGPL-3.0">the license which governs it</a>. Relay stands on the shoulders of giants — not only the Mattermost source code but Linux, GoLang, React, and hundreds of other projects. Here, between the spirit and the letter of Open Philosophies, exists a great deal of nuance. Cutting through this nuance is a root concept, however: “share alike.” If we take something from the free/open software community, what we return to that community should afford the next recipient the same freedoms we had. If we tweak Relay’s design until it is absolutely perfect but that involves changes which Mattermost cannot absorb upstream, we have failed them and every other project we have built ourselves upon. Thus, our icons must have an open license. — Steven Deobald</blockquote><p>Thanks Steve. Keeping the above mentioned points in mind, there were three icon sets that made the final round of discussion:</p><ul><li><a href="https://vmware.github.io/clarity/icons/icon-sets">Clarity icons</a></li><li><a href="https://feathericons.com/">Feather icons</a></li><li><a href="https://useiconic.com/open">Iconic icons</a></li></ul><p>We chose the Clarity icon set because of styles, consistency, and the icons being part of a design language system. Clarity is an open source design system created and maintained by the good folks at VMware. Since VMware has a dedicated team pushing continuous updates there is little fear the icon set will be abandoned or go stale.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*8YedTvLmvirplj0sFZ8_EA.png" /></figure><h3>Font</h3><p>Our font selection followed the same rules:</p><ul><li>Fonts <strong>must</strong> be open source</li><li>Fonts should be available in multiple weights</li></ul><p>…along with these additions:</p><ul><li>Fonts with large x-height for easy readability</li><li>Fonts with thick Regular weight so fonts will be crisp</li></ul><p>We stress so much on font weights because Relay is, first and foremost, a messaging tool. In Relay, you spend most of your time reading and we want this experience to be as enjoyable as possible. Relay also has complete Markdown support and weights help establish hierarchy both within the app and within the messages themselves.</p><p>We had a few contenders which satisfied these requirements. PT Sans, Lato, and Noto Sans all have an enjoyable reading experience but after a lot of trial and error we chose Fira Sans.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*zKRXBmPhm29XOuEAIu-V1Q.png" /></figure><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*cFZx7FuOzEfaRXvzkL9-3w.png" /></figure><p>Fira Sans is an incredible font. It has a healthy variety of weights and the compressed nature of the font holds the messaging interface together while keeping it crisp.</p><blockquote>Did you know that Fira Sans was built on top of Erik Spiekermann’s commercial font FF Meta? And that Spiekermann was commissioned by the Mozilla Foundation! <a href="http://typographica.org/typeface-reviews/fira-sans/">Read the whole story here</a></blockquote><h3>How Mattermost became Relay</h3><p>Implementing the design basics improved the existing experience. But to make those changes truly delightful we need to fine-tune every aspect of the app. We have started with three major sections:</p><ol><li>Left sidebar</li><li>Channel header</li><li>Main messaging interface</li></ol><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*Nxo6ha36AGdYC5yTbPM-4g.png" /><figcaption>Present Mattermost interface</figcaption></figure><h4>1. Left sidebar</h4><p>The sidebar’s Team section allows users to switch between teams within organisations that they’re a part of. The current Mattermost implementation truncates the team name and adds a byline. The problem with this is that it does not add any value since hovering over the team opens a tooltip with the team name anyway. We removed the byline and the truncated text.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*9SkvIpcpCoZcPqK_aQyg3w.png" /></figure><p>The sidebar’s Channel section felt mashed together. There is a clear hierarchy intended, which includes channel headers such as “Favorite Channels” and a distinction between active and inactive channels. We brought this hierarchy to the surface. Active channels have a heavy weight and inactive channels fade away with a lower opacity, despite the <em>increased</em> crispness of Fira Sans.</p><p>Grouped channels now have tighter spacing and groups themselves have larger spacing, allowing group titles to have a smaller font. All together, this makes the hierarchy obvious even at a glance.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*hiZL-Z9BvrCqgQmi1KZL3w.png" /></figure><h4>2. Channel header</h4><p>In the channel header we cleaned up the icons. Here are the issues we encountered with the icons:</p><ul><li>Most icons weren’t of the same weight</li><li>Some icons were of a different size</li><li>Some icons had some positioning overrides to align them</li></ul><p>The old icons for the channel header stood out, drawing attention away from the main chat area. We wanted them instead to blend into the design — unobtrusive but still obvious. To do this we removed the borders and switched the icon set to Clarity.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*JPH74EFnVALhnJT40VyJEQ.png" /></figure><p>In addition to icons, we fixed the CSS for the header and right sidebar, getting rid of all funny margins and relative positioning. We also added consistent heights, paddings, and sizes for each of the icons. These fixes don’t just add polish to the UI; once merged, they will also ensure it is easier for anyone in the community, including us, to customise Mattermost.</p><h4>3. Messaging interface</h4><p>The messaging interface is where users spend the most time. The messaging interface is also where Mattermost has most of its design inconsistencies, which are most glaring in the basics: alignment, spacing between posts, font size, and other elements on the interface such as the reply box.</p><p>After we moved to Fira Sans we bumped up the font size, made sure the headings and names are bolded to establish hierarchy, and fixed alignment and spacing issues to deliver a crisper and more enjoyable reading experience.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*fHEbMdPuBuTKZTOBIFOrLg.png" /></figure><h3>Themes</h3><p>Accessibility matters. We have light-sensitive coworkers and we’re sure you do, too. That’s why Relay comes with light and dark themes out of the box.</p><p>There are many Relay/Mattermost-compatible themes available already but we will pour all our energy into these two. They already make Relay beautiful and with every <a href="https://en.wikipedia.org/wiki/Kaizen">kaizen</a> they will only get better.</p><p>Of course, we don’t restrict you to these two themes. Relay also comes with community themes and Relay’s entire colour scheme is fully customisable… not just the sidebar (<em>cough</em> Slack <em>cough</em>). We are working to make Relay <a href="https://trello.com/c/rAjOFRmw">100% customisable through CSS</a> so users have complete control over every aspect of the UI, if they want.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*Xi8y7fGywOWfNpZPAYbxPA.png" /></figure><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*RSYA2D6Mbd-RgxbbYPcANQ.png" /></figure><h3>Putting it all together</h3><p>By following a consistent design language for icons, font, and themes we ensure all our “pieces” are whole unto themselves. Putting them back together, the application itself becomes whole.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*w6L79VGBNKJy4pKu-qhK1A.png" /></figure><p>Mattermost has published a <a href="https://github.com/mattermost/mattermost-server/issues/8350">design challenge</a> that encourages designers from all over the world to improve Mattermost (and, hence, Relay) readability and usability. <a href="https://github.com/mattermost/mattermost-webapp/pull/971">Our redesign addresses this challenge</a>.</p><p><a href="https://relay-chat.com/signup">Sign up</a>, try the redesign, and tell us what you think!</p><p>Along with visual design changes, Relay also aims to significantly improve its user experience. Our <a href="https://trello.com/b/OaHPWOAi">public Trello board</a> contains our plan for Relay’s future.</p><h3>Future</h3><p>“Design” is the <a href="https://medium.com/@baditaflorin/inside-the-top-1000-tags-on-medium-com-part-1-a1ff96356639">8th most popular tag on Medium</a>. “Open Source” is ranked 290. Source code licenses will never be sexy for the same reason your city’s water utility company will never be. The water supply is inherently a part of your city’s design. Similarly, your freedom as a user is designed into software you buy. Your ownership of a product is but one more limb in the tree of design.</p><blockquote>Open source software needs good design because good design respects you, the user.</blockquote><blockquote>❤</blockquote><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*g6rztkAO4PgkBPPYG0A91w.png" /><figcaption>Illustration by <a href="https://www.instagram.com/basementtaco/">Shrishti Ambani</a></figcaption></figure><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=65ea40616c5a" width="1" height="1"><hr><p><a href="https://medium.com/the-relay/designing-for-open-source-software-65ea40616c5a">Designing for Open Source Software</a> was originally published in <a href="https://medium.com/the-relay">The Relay</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p><div class="author">
  <img src="https://nilenso.com/images/people/varun-200.png" style="width: 96px; height: 96;">
  <span style="position: absolute; padding: 32px 15px;">
    <i>Original post by <a href="http://twitter.com/">Varun Pai</a> - check out <a href="https://medium.com/@irrational_pai?source=rss-3a83e65683fa------2">Stories by Varun Pai on Medium</a></i>
  </span>
</div></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2017/10/01/writing-a-simple-rest-web-service-in-purescript-p/">Writing a Simple REST Web Service in PureScript - Part 2</a></h1>
      
      
    
      <p class="meta">
        









<time datetime="2017-10-01T00:00:00-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>To recap, in the <a href="https://abhinavsarkar.net/posts/ps-simple-rest-service/">first</a> part of this two-part tutorial, we built a simple JSON <a href="https://en.wikipedia.org/wiki/REST" target="_blank" rel="noopener">REST</a> web service in <a href="http://purescript.org" target="_blank" rel="noopener">PureScript</a> to create, update, get, list and delete users, backed by a Postgres database. In this part we’ll work on the rest of the features. <!--more--> The requirements are:</p>


<ol type="1">
<li>validation of API requests.</li>
<li>reading the server and database configs from environment variables.</li>
<li>logging HTTP requests and debugging info.</li>
</ol>


<p><nav id="toc" class="right-toc"><h3>Contents</h3><ol><li><a href="#bugs">Bugs!</a></li><li><a href="#validation">Validation</a></li><li><a href="#configuration">Configuration</a></li><li><a href="#logging">Logging</a></li><li><a href="#conclusion">Conclusion</a></li></ol></nav></p>

<p>But first,</p>


<h2 id="bugs" data-track-content data-content-name="bugs" data-content-piece="ps-simple-rest-service-2">Bugs!<a href="#bugs" class="ref-link"></a><a href="#top" class="top-link" title="Back to top"></a></h2>


<p>What happens if we hit a URL on our server which does not exist? Let’s fire up the server and test it:</p>


<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">$ <span class="ex">pulp</span> --watch run</a></code></pre></div>


<pre class="http"><code>$ http GET http://localhost:4000/v1/random
HTTP/1.1 404 Not Found
Connection: keep-alive
Content-Length: 148
Content-Security-Policy: default-src 'self'
Content-Type: text/html; charset=utf-8
Date: Sat, 30 Sep 2017 08:23:20 GMT
X-Content-Type-Options: nosniff
X-Powered-By: Express

&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;title&gt;Error&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;pre&gt;Cannot GET /v1/random&lt;/pre&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>


<p>We get back a default HTML response with a 404 status from <a href="https://expressjs.com" target="_blank" rel="noopener">Express</a>. Since we are writing a JSON API, we should return a JSON response in this case too. We add the following code in the <code>src/SimpleService/Server.purs</code> file to add a catch-all route and send a 404 status with a JSON error message:</p>


<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">-- previous code</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Data.Either</span> (fromRight)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">import</span> <span class="dt">Data.String.Regex</span> (<span class="dt">Regex</span>, regex) <span class="kw">as</span> <span class="dt">Re</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">import</span> <span class="dt">Data.String.Regex.Flags</span> (noFlags) <span class="kw">as</span> <span class="dt">Re</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">import</span> <span class="dt">Node.Express.App</span> (<span class="dt">App</span>, all, delete, get, http, listenHttp, post, useExternal)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw">import</span> <span class="dt">Node.Express.Response</span> (sendJson, setStatus)</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Partial.Unsafe</span> (unsafePartial)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">-- previous code</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="ot">allRoutePattern ::</span> <span class="dt">Re.Regex</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">allRoutePattern <span class="fu">=</span> unsafePartial <span class="fu">$</span> fromRight <span class="fu">$</span> Re.regex <span class="st">&quot;/.*&quot;</span> Re.noFlags</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="ot">app ::</span> forall eff<span class="fu">.</span> <span class="dt">PG.Pool</span> <span class="ot">-&gt;</span> <span class="dt">App</span> (<span class="ot">postgreSQL ::</span> <span class="dt">PG.POSTGRESQL</span> <span class="fu">|</span> eff)</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">app pool <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15">  useExternal jsonBodyParser</a>
<a class="sourceLine" id="cb3-16" data-line-number="16"></a>
<a class="sourceLine" id="cb3-17" data-line-number="17">  get <span class="st">&quot;/v1/user/:id&quot;</span>    <span class="fu">$</span> getUser pool</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">  delete <span class="st">&quot;/v1/user/:id&quot;</span> <span class="fu">$</span> deleteUser pool</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">  post <span class="st">&quot;/v1/users&quot;</span>      <span class="fu">$</span> createUser pool</a>
<a class="sourceLine" id="cb3-20" data-line-number="20">  patch <span class="st">&quot;/v1/user/:id&quot;</span>  <span class="fu">$</span> updateUser pool</a>
<a class="sourceLine" id="cb3-21" data-line-number="21">  get <span class="st">&quot;/v1/users&quot;</span>       <span class="fu">$</span> listUsers pool</a>
<a class="sourceLine" id="cb3-22" data-line-number="22"></a>
<a class="sourceLine" id="cb3-23" data-line-number="23">  all allRoutePattern <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24">    setStatus <span class="dv">404</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25">    sendJson {error<span class="fu">:</span> <span class="st">&quot;Route not found&quot;</span>}</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27">    patch <span class="fu">=</span> http (<span class="dt">CustomMethod</span> <span class="st">&quot;patch&quot;</span>)</a></code></pre></div>


<p><code>allRoutePattern</code> matches all routes because it uses a <code>&quot;/.*&quot;</code> <a href="https://en.wikipedia.org/wiki/Regular_expression" target="_blank" rel="noopener">regular expression</a>. We place it as the last route to match all the otherwise unrouted requests. Let’s see what is the result:</p>


<pre class="http"><code>$ http GET http://localhost:4000/v1/random
HTTP/1.1 404 Not Found
Connection: keep-alive
Content-Length: 27
Content-Type: application/json; charset=utf-8
Date: Sat, 30 Sep 2017 08:46:46 GMT
ETag: W/&quot;1b-772e0u4nrE48ogbR0KmKfSvrHUE&quot;
X-Powered-By: Express

{
    &quot;error&quot;: &quot;Route not found&quot;
}</code></pre>


<p>Now we get a nicely formatted JSON response.</p>


<p>Another scenario is when our application throws some uncaught error. To simulate this, we shut down our postgres database and hit the server for listing users:</p>


<pre class="http"><code>$ http GET http://localhost:4000/v1/users
HTTP/1.1 500 Internal Server Error
Connection: keep-alive
Content-Length: 372
Content-Security-Policy: default-src 'self'
Content-Type: text/html; charset=utf-8
Date: Sat, 30 Sep 2017 08:53:40 GMT
X-Content-Type-Options: nosniff
X-Powered-By: Express

&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;title&gt;Error&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;pre&gt;Error: connect ECONNREFUSED 127.0.0.1:5432&lt;br&gt; &amp;nbsp; &amp;nbsp;at Object._errnoException (util.js:1026:11)&lt;br&gt; &amp;nbsp; &amp;nbsp;at _exceptionWithHostPort (util.js:1049:20)&lt;br&gt; &amp;nbsp; &amp;nbsp;at TCPConnectWrap.afterConnect [as oncomplete] (net.js:1174:14)&lt;/pre&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>


<p>We get another default HTML response from Express with a 500 status. Again, in this case we’d like to return a JSON response. We add the following code to the <code>src/SimpleService/Server.purs</code> file:</p>


<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co">-- previous code</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Control.Monad.Eff.Exception</span> (message)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="kw">import</span> <span class="dt">Node.Express.App</span> (<span class="dt">App</span>, all, delete, get, http, listenHttp, post, useExternal, useOnError)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">-- previous code</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="ot">app ::</span> forall eff<span class="fu">.</span> <span class="dt">PG.Pool</span> <span class="ot">-&gt;</span> <span class="dt">App</span> (<span class="ot">postgreSQL ::</span> <span class="dt">PG.POSTGRESQL</span> <span class="fu">|</span> eff)</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">app pool <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">  <span class="co">-- previous code</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">  useOnError \err <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">    setStatus <span class="dv">500</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">    sendJson {error<span class="fu">:</span> message err}</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">    patch <span class="fu">=</span> http (<span class="dt">CustomMethod</span> <span class="st">&quot;patch&quot;</span>)</a></code></pre></div>


<p>We add the <code>useOnError</code> handler which comes with <a href="https://pursuit.purescript.org/packages/purescript-express" target="_blank" rel="noopener"><code>purescript-express</code></a> to return the error message as a JSON response. Back on the command-line:</p>


<pre class="http"><code>$ http GET http://localhost:4000/v1/users
HTTP/1.1 500 Internal Server Error
Connection: keep-alive
Content-Length: 47
Content-Type: application/json; charset=utf-8
Date: Sat, 30 Sep 2017 09:01:37 GMT
ETag: W/&quot;2f-cJuIW6961YCpo9TWDSZ9VWHLGHE&quot;
X-Powered-By: Express

{
    &quot;error&quot;: &quot;connect ECONNREFUSED 127.0.0.1:5432&quot;
}</code></pre>


<p>It works! Bugs are fixed now. We proceed to add next features.</p>


<h2 id="validation" data-track-content data-content-name="validation" data-content-piece="ps-simple-rest-service-2">Validation<a href="#validation" class="ref-link"></a><a href="#top" class="top-link" title="Back to top"></a></h2>


<p>Let’s recall the code to update a user from the <code>src/SimpleService/Handler.purs</code> file:</p>


<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="ot">updateUser ::</span> forall eff<span class="fu">.</span> <span class="dt">PG.Pool</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> (<span class="ot">postgreSQL ::</span> <span class="dt">PG.POSTGRESQL</span> <span class="fu">|</span> eff)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">updateUser pool <span class="fu">=</span> getRouteParam <span class="st">&quot;id&quot;</span> <span class="fu">&gt;&gt;=</span> <span class="kw">case</span> _ <span class="kw">of</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="dt">Nothing</span> <span class="ot">-&gt;</span> respond <span class="dv">422</span> { error<span class="fu">:</span> <span class="st">&quot;User ID is required&quot;</span> }</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  <span class="dt">Just</span> sUserId <span class="ot">-&gt;</span> <span class="kw">case</span> fromString sUserId <span class="kw">of</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> respond <span class="dv">422</span> { error<span class="fu">:</span> <span class="st">&quot;User ID must be positive: &quot;</span> <span class="fu">&lt;&gt;</span> sUserId }</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">    <span class="dt">Just</span> userId <span class="ot">-&gt;</span> getBody <span class="fu">&gt;&gt;=</span> <span class="kw">case</span> _ <span class="kw">of</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">      <span class="dt">Left</span> errs <span class="ot">-&gt;</span> respond <span class="dv">422</span> { error<span class="fu">:</span> intercalate <span class="st">&quot;, &quot;</span> <span class="fu">$</span> map renderForeignError errs}</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">      <span class="dt">Right</span> (<span class="dt">UserPatch</span> userPatch) <span class="ot">-&gt;</span> <span class="kw">case</span> unNullOrUndefined userPatch<span class="fu">.</span>name <span class="kw">of</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9">        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> respondNoContent <span class="dv">204</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">        <span class="dt">Just</span> userName <span class="ot">-&gt;</span> <span class="kw">if</span> userName <span class="fu">==</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">          <span class="kw">then</span> respond <span class="dv">422</span> { error<span class="fu">:</span> <span class="st">&quot;User name must not be empty&quot;</span> }</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">          <span class="kw">else</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">            savedUser <span class="ot">&lt;-</span> liftAff <span class="fu">$</span> PG.withConnection pool \conn <span class="ot">-&gt;</span> PG.withTransaction conn <span class="kw">do</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14">              P.findUser conn userId <span class="fu">&gt;&gt;=</span> <span class="kw">case</span> _ <span class="kw">of</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15">                <span class="dt">Nothing</span> <span class="ot">-&gt;</span> pure <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16">                <span class="dt">Just</span> (<span class="dt">User</span> user) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb8-17" data-line-number="17">                  <span class="kw">let</span> user' <span class="fu">=</span> <span class="dt">User</span> (user { name <span class="fu">=</span> userName })</a>
<a class="sourceLine" id="cb8-18" data-line-number="18">                  P.updateUser conn user'</a>
<a class="sourceLine" id="cb8-19" data-line-number="19">                  pure <span class="fu">$</span> <span class="dt">Just</span> user'</a>
<a class="sourceLine" id="cb8-20" data-line-number="20">            <span class="kw">case</span> savedUser <span class="kw">of</span></a>
<a class="sourceLine" id="cb8-21" data-line-number="21">              <span class="dt">Nothing</span> <span class="ot">-&gt;</span> respond <span class="dv">404</span> { error<span class="fu">:</span> <span class="st">&quot;User not found with id: &quot;</span> <span class="fu">&lt;&gt;</span> sUserId }</a>
<a class="sourceLine" id="cb8-22" data-line-number="22">              <span class="dt">Just</span> user <span class="ot">-&gt;</span> respond <span class="dv">200</span> (encode user)</a></code></pre></div>


<p>As we can see, the actual request handling logic is obfuscated by the request validation logic for the user id and the user name patch parameters. We also notice that we are using three constructs for validation here: <code>Maybe</code>, <code>Either</code> and <code>if-then-else</code>. However, we can use just <code>Either</code> to subsume all these cases as it can “carry” a failure as well as a success case. <code>Either</code> also comes with a nice monad transformer <a href="https://pursuit.purescript.org/packages/purescript-transformers/3.4.0/docs/Control.Monad.Except.Trans#t:ExceptT" target="_blank" rel="noopener"><code>ExceptT</code></a> which provides the <code>do</code> syntax for failure propagation. So we choose <code>ExceptT</code> as the base construct for our validation framework and write functions to upgrade <code>Maybe</code> and <code>if-then-else</code> to it. We add the following code to the <code>src/SimpleService/Validation.purs</code> file:</p>


<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">module</span> <span class="dt">SimpleService.Validation</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  (<span class="kw">module</span> <span class="dt">MoreExports</span>, <span class="kw">module</span> <span class="dt">SimpleService.Validation</span>) <span class="kw">where</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="kw">import</span> <span class="dt">Prelude</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="kw">import</span> <span class="dt">Control.Monad.Except</span> (<span class="dt">ExceptT</span>, except, runExceptT)</a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Data.Either</span> (<span class="dt">Either</span>(..))</a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="kw">import</span> <span class="dt">Data.Maybe</span> (<span class="dt">Maybe</span>(..))</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Node.Express.Handler</span> (<span class="dt">HandlerM</span>, <span class="dt">Handler</span>)</a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Node.Express.Response</span> (sendJson, setStatus)</a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Node.Express.Types</span> (<span class="dt">EXPRESS</span>)</a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Control.Monad.Except</span> (except) <span class="kw">as</span> <span class="dt">MoreExports</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="kw">type</span> <span class="dt">Validation</span> eff a <span class="fu">=</span> <span class="dt">ExceptT</span> <span class="dt">String</span> (<span class="dt">HandlerM</span> (<span class="ot">express ::</span> <span class="dt">EXPRESS</span> <span class="fu">|</span> eff)) a</a>
<a class="sourceLine" id="cb9-15" data-line-number="15"></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="ot">exceptMaybe ::</span> forall e m a<span class="fu">.</span> <span class="dt">Applicative</span> m <span class="ot">=&gt;</span> e <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> <span class="dt">ExceptT</span> e m a</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">exceptMaybe e a <span class="fu">=</span> except <span class="fu">$</span> <span class="kw">case</span> a <span class="kw">of</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18">  <span class="dt">Just</span> x  <span class="ot">-&gt;</span> <span class="dt">Right</span> x</a>
<a class="sourceLine" id="cb9-19" data-line-number="19">  <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Left</span> e</a>
<a class="sourceLine" id="cb9-20" data-line-number="20"></a>
<a class="sourceLine" id="cb9-21" data-line-number="21"><span class="ot">exceptCond ::</span> forall e m a<span class="fu">.</span> <span class="dt">Applicative</span> m <span class="ot">=&gt;</span> e <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Boolean</span>) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">ExceptT</span> e m a</a>
<a class="sourceLine" id="cb9-22" data-line-number="22">exceptCond e cond a <span class="fu">=</span> except <span class="fu">$</span> <span class="kw">if</span> cond a <span class="kw">then</span> <span class="dt">Right</span> a <span class="kw">else</span> <span class="dt">Left</span> e</a>
<a class="sourceLine" id="cb9-23" data-line-number="23"></a>
<a class="sourceLine" id="cb9-24" data-line-number="24"><span class="ot">withValidation ::</span> forall eff a<span class="fu">.</span> <span class="dt">Validation</span> eff a <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Handler</span> eff) <span class="ot">-&gt;</span> <span class="dt">Handler</span> eff</a>
<a class="sourceLine" id="cb9-25" data-line-number="25">withValidation action handler <span class="fu">=</span> runExceptT action <span class="fu">&gt;&gt;=</span> <span class="kw">case</span> _ <span class="kw">of</span></a>
<a class="sourceLine" id="cb9-26" data-line-number="26">  <span class="dt">Left</span> err <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb9-27" data-line-number="27">    setStatus <span class="dv">422</span></a>
<a class="sourceLine" id="cb9-28" data-line-number="28">    sendJson {error<span class="fu">:</span> err}</a>
<a class="sourceLine" id="cb9-29" data-line-number="29">  <span class="dt">Right</span> x  <span class="ot">-&gt;</span> handler x</a></code></pre></div>


<p>We re-export <code>except</code> from the <code>Control.Monad.Except</code> module. We also add a <code>withValidation</code> function which runs an <code>ExceptT</code> based validation and either returns an error response with a 422 status in case of a failed validation or runs the given action with the valid value in case of a successful validation.</p>


<p>Using these functions, we now write <code>updateUser</code> in the <code>src/SimpleService/Handler.purs</code> file as:</p>


<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co">-- previous code</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Control.Monad.Trans.Class</span> (lift)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="kw">import</span> <span class="dt">Data.Bifunctor</span> (lmap)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="kw">import</span> <span class="dt">Data.Foreign</span> (<span class="dt">ForeignError</span>, renderForeignError)</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="kw">import</span> <span class="dt">Data.List.NonEmpty</span> (toList)</a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="kw">import</span> <span class="dt">Data.List.Types</span> (<span class="dt">NonEmptyList</span>)</a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Data.Tuple</span> (<span class="dt">Tuple</span>(..))</a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="kw">import</span> <span class="dt">SimpleService.Validation</span> <span class="kw">as</span> <span class="dt">V</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co">-- previous code</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="ot">renderForeignErrors ::</span> forall a<span class="fu">.</span> <span class="dt">Either</span> (<span class="dt">NonEmptyList</span> <span class="dt">ForeignError</span>) a <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">String</span> a</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">renderForeignErrors <span class="fu">=</span> lmap (toList <span class="fu">&gt;&gt;&gt;</span> map renderForeignError <span class="fu">&gt;&gt;&gt;</span> intercalate <span class="st">&quot;, &quot;</span>)</a>
<a class="sourceLine" id="cb10-13" data-line-number="13"></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="ot">updateUser ::</span> forall eff<span class="fu">.</span> <span class="dt">PG.Pool</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> (<span class="ot">postgreSQL ::</span> <span class="dt">PG.POSTGRESQL</span> <span class="fu">|</span> eff)</a>
<a class="sourceLine" id="cb10-15" data-line-number="15">updateUser pool <span class="fu">=</span> V.withValidation (<span class="dt">Tuple</span> <span class="fu">&lt;$&gt;</span> getUserId <span class="fu">&lt;*&gt;</span> getUserPatch)</a>
<a class="sourceLine" id="cb10-16" data-line-number="16">                                   \(<span class="dt">Tuple</span> userId (<span class="dt">UserPatch</span> userPatch)) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">    <span class="kw">case</span> unNullOrUndefined userPatch<span class="fu">.</span>name <span class="kw">of</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18">      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> respondNoContent <span class="dv">204</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19">      <span class="dt">Just</span> uName <span class="ot">-&gt;</span> V.withValidation (getUserName uName) \userName <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20">        savedUser <span class="ot">&lt;-</span> liftAff <span class="fu">$</span> PG.withConnection pool \conn <span class="ot">-&gt;</span> PG.withTransaction conn <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21">          P.findUser conn userId <span class="fu">&gt;&gt;=</span> <span class="kw">case</span> _ <span class="kw">of</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22">            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> pure <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb10-23" data-line-number="23">            <span class="dt">Just</span> (<span class="dt">User</span> user) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb10-24" data-line-number="24">              <span class="kw">let</span> user' <span class="fu">=</span> <span class="dt">User</span> (user { name <span class="fu">=</span> userName })</a>
<a class="sourceLine" id="cb10-25" data-line-number="25">              P.updateUser conn user'</a>
<a class="sourceLine" id="cb10-26" data-line-number="26">              pure <span class="fu">$</span> <span class="dt">Just</span> user'</a>
<a class="sourceLine" id="cb10-27" data-line-number="27">        <span class="kw">case</span> savedUser <span class="kw">of</span></a>
<a class="sourceLine" id="cb10-28" data-line-number="28">          <span class="dt">Nothing</span> <span class="ot">-&gt;</span> respond <span class="dv">404</span> { error<span class="fu">:</span> <span class="st">&quot;User not found with id: &quot;</span> <span class="fu">&lt;&gt;</span> show userId }</a>
<a class="sourceLine" id="cb10-29" data-line-number="29">          <span class="dt">Just</span> user <span class="ot">-&gt;</span> respond <span class="dv">200</span> (encode user)</a>
<a class="sourceLine" id="cb10-30" data-line-number="30">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb10-31" data-line-number="31">    getUserId <span class="fu">=</span> lift (getRouteParam <span class="st">&quot;id&quot;</span>)</a>
<a class="sourceLine" id="cb10-32" data-line-number="32">      <span class="fu">&gt;&gt;=</span> V.exceptMaybe <span class="st">&quot;User ID is required&quot;</span></a>
<a class="sourceLine" id="cb10-33" data-line-number="33">      <span class="fu">&gt;&gt;=</span> fromString <span class="fu">&gt;&gt;&gt;</span> V.exceptMaybe <span class="st">&quot;User ID must be positive&quot;</span></a>
<a class="sourceLine" id="cb10-34" data-line-number="34"></a>
<a class="sourceLine" id="cb10-35" data-line-number="35">    getUserPatch <span class="fu">=</span> lift getBody <span class="fu">&gt;&gt;=</span> V.except <span class="fu">&lt;&lt;&lt;</span> renderForeignErrors</a>
<a class="sourceLine" id="cb10-36" data-line-number="36"></a>
<a class="sourceLine" id="cb10-37" data-line-number="37">    getUserName <span class="fu">=</span> V.exceptCond <span class="st">&quot;User name must not be empty&quot;</span> (_ <span class="fu">==</span> <span class="st">&quot;&quot;</span>)</a></code></pre></div>


<p>The validation logic has been extracted out in separate functions now which are composed using <a href="https://pursuit.purescript.org/packages/purescript-prelude/3.0.0/docs/Control.Applicative#t:Applicative" target="_blank" rel="noopener">Applicative</a>. The validation steps are composed using the <code>ExceptT</code> monad. We are now free to express the core logic of the function clearly. We rewrite the <code>src/SimpleService/Handler.purs</code> file using the validations:</p>


<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">module</span> <span class="dt">SimpleService.Handler</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="kw">import</span> <span class="dt">Prelude</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="kw">import</span> <span class="dt">Control.Monad.Aff.Class</span> (liftAff)</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="kw">import</span> <span class="dt">Control.Monad.Trans.Class</span> (lift)</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Data.Bifunctor</span> (lmap)</a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="kw">import</span> <span class="dt">Data.Either</span> (<span class="dt">Either</span>)</a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Data.Foldable</span> (intercalate)</a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Data.Foreign</span> (<span class="dt">ForeignError</span>, renderForeignError)</a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Data.Foreign.Class</span> (encode)</a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Data.Foreign.NullOrUndefined</span> (unNullOrUndefined)</a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Data.Int</span> (fromString)</a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="kw">import</span> <span class="dt">Data.List.NonEmpty</span> (toList)</a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="kw">import</span> <span class="dt">Data.List.Types</span> (<span class="dt">NonEmptyList</span>)</a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="kw">import</span> <span class="dt">Data.Maybe</span> (<span class="dt">Maybe</span>(..))</a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="kw">import</span> <span class="dt">Data.Tuple</span> (<span class="dt">Tuple</span>(..))</a>
<a class="sourceLine" id="cb11-18" data-line-number="18"><span class="kw">import</span> <span class="dt">Database.PostgreSQL</span> <span class="kw">as</span> <span class="dt">PG</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19"><span class="kw">import</span> <span class="dt">Node.Express.Handler</span> (<span class="dt">Handler</span>)</a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="kw">import</span> <span class="dt">Node.Express.Request</span> (getBody, getRouteParam)</a>
<a class="sourceLine" id="cb11-21" data-line-number="21"><span class="kw">import</span> <span class="dt">Node.Express.Response</span> (end, sendJson, setStatus)</a>
<a class="sourceLine" id="cb11-22" data-line-number="22"><span class="kw">import</span> <span class="dt">SimpleService.Persistence</span> <span class="kw">as</span> <span class="dt">P</span></a>
<a class="sourceLine" id="cb11-23" data-line-number="23"><span class="kw">import</span> <span class="dt">SimpleService.Validation</span> <span class="kw">as</span> <span class="dt">V</span></a>
<a class="sourceLine" id="cb11-24" data-line-number="24"><span class="kw">import</span> <span class="dt">SimpleService.Types</span></a>
<a class="sourceLine" id="cb11-25" data-line-number="25"></a>
<a class="sourceLine" id="cb11-26" data-line-number="26"><span class="ot">getUser ::</span> forall eff<span class="fu">.</span> <span class="dt">PG.Pool</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> (<span class="ot">postgreSQL ::</span> <span class="dt">PG.POSTGRESQL</span> <span class="fu">|</span> eff)</a>
<a class="sourceLine" id="cb11-27" data-line-number="27">getUser pool <span class="fu">=</span> V.withValidation getUserId \userId <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb11-28" data-line-number="28">  liftAff (PG.withConnection pool <span class="fu">$</span> flip P.findUser userId) <span class="fu">&gt;&gt;=</span> <span class="kw">case</span> _ <span class="kw">of</span></a>
<a class="sourceLine" id="cb11-29" data-line-number="29">    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> respond <span class="dv">404</span> { error<span class="fu">:</span> <span class="st">&quot;User not found with id: &quot;</span> <span class="fu">&lt;&gt;</span> show userId }</a>
<a class="sourceLine" id="cb11-30" data-line-number="30">    <span class="dt">Just</span> user <span class="ot">-&gt;</span> respond <span class="dv">200</span> (encode user)</a>
<a class="sourceLine" id="cb11-31" data-line-number="31"></a>
<a class="sourceLine" id="cb11-32" data-line-number="32"><span class="ot">deleteUser ::</span> forall eff<span class="fu">.</span> <span class="dt">PG.Pool</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> (<span class="ot">postgreSQL ::</span> <span class="dt">PG.POSTGRESQL</span> <span class="fu">|</span> eff)</a>
<a class="sourceLine" id="cb11-33" data-line-number="33">deleteUser pool <span class="fu">=</span> V.withValidation getUserId \userId <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-34" data-line-number="34">  found <span class="ot">&lt;-</span> liftAff <span class="fu">$</span> PG.withConnection pool \conn <span class="ot">-&gt;</span> PG.withTransaction conn <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-35" data-line-number="35">    P.findUser conn userId <span class="fu">&gt;&gt;=</span> <span class="kw">case</span> _ <span class="kw">of</span></a>
<a class="sourceLine" id="cb11-36" data-line-number="36">      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> pure false</a>
<a class="sourceLine" id="cb11-37" data-line-number="37">      <span class="dt">Just</span> _  <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-38" data-line-number="38">        P.deleteUser conn userId</a>
<a class="sourceLine" id="cb11-39" data-line-number="39">        pure true</a>
<a class="sourceLine" id="cb11-40" data-line-number="40">  <span class="kw">if</span> found</a>
<a class="sourceLine" id="cb11-41" data-line-number="41">    <span class="kw">then</span> respondNoContent <span class="dv">204</span></a>
<a class="sourceLine" id="cb11-42" data-line-number="42">    <span class="kw">else</span> respond <span class="dv">404</span> { error<span class="fu">:</span> <span class="st">&quot;User not found with id: &quot;</span> <span class="fu">&lt;&gt;</span> show userId }</a>
<a class="sourceLine" id="cb11-43" data-line-number="43"></a>
<a class="sourceLine" id="cb11-44" data-line-number="44"><span class="ot">createUser ::</span> forall eff<span class="fu">.</span> <span class="dt">PG.Pool</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> (<span class="ot">postgreSQL ::</span> <span class="dt">PG.POSTGRESQL</span> <span class="fu">|</span> eff)</a>
<a class="sourceLine" id="cb11-45" data-line-number="45">createUser pool <span class="fu">=</span> V.withValidation getUser \user<span class="fu">@</span>(<span class="dt">User</span> _) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-46" data-line-number="46">  liftAff (PG.withConnection pool <span class="fu">$</span> flip P.insertUser user)</a>
<a class="sourceLine" id="cb11-47" data-line-number="47">  respondNoContent <span class="dv">201</span></a>
<a class="sourceLine" id="cb11-48" data-line-number="48">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb11-49" data-line-number="49">    getUser <span class="fu">=</span> lift getBody</a>
<a class="sourceLine" id="cb11-50" data-line-number="50">      <span class="fu">&gt;&gt;=</span> V.except <span class="fu">&lt;&lt;&lt;</span> renderForeignErrors</a>
<a class="sourceLine" id="cb11-51" data-line-number="51">      <span class="fu">&gt;&gt;=</span> V.exceptCond <span class="st">&quot;User ID must be positive&quot;</span> (\(<span class="dt">User</span> user) <span class="ot">-&gt;</span> user<span class="fu">.</span>id <span class="fu">&gt;</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb11-52" data-line-number="52">      <span class="fu">&gt;&gt;=</span> V.exceptCond <span class="st">&quot;User name must not be empty&quot;</span> (\(<span class="dt">User</span> user) <span class="ot">-&gt;</span> user<span class="fu">.</span>name <span class="fu">/=</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-53" data-line-number="53"></a>
<a class="sourceLine" id="cb11-54" data-line-number="54"><span class="ot">updateUser ::</span> forall eff<span class="fu">.</span> <span class="dt">PG.Pool</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> (<span class="ot">postgreSQL ::</span> <span class="dt">PG.POSTGRESQL</span> <span class="fu">|</span> eff)</a>
<a class="sourceLine" id="cb11-55" data-line-number="55">updateUser pool <span class="fu">=</span> V.withValidation (<span class="dt">Tuple</span> <span class="fu">&lt;$&gt;</span> getUserId <span class="fu">&lt;*&gt;</span> getUserPatch)</a>
<a class="sourceLine" id="cb11-56" data-line-number="56">                                   \(<span class="dt">Tuple</span> userId (<span class="dt">UserPatch</span> userPatch)) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb11-57" data-line-number="57">    <span class="kw">case</span> unNullOrUndefined userPatch<span class="fu">.</span>name <span class="kw">of</span></a>
<a class="sourceLine" id="cb11-58" data-line-number="58">      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> respondNoContent <span class="dv">204</span></a>
<a class="sourceLine" id="cb11-59" data-line-number="59">      <span class="dt">Just</span> uName <span class="ot">-&gt;</span> V.withValidation (getUserName uName) \userName <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-60" data-line-number="60">        savedUser <span class="ot">&lt;-</span> liftAff <span class="fu">$</span> PG.withConnection pool \conn <span class="ot">-&gt;</span> PG.withTransaction conn <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-61" data-line-number="61">          P.findUser conn userId <span class="fu">&gt;&gt;=</span> <span class="kw">case</span> _ <span class="kw">of</span></a>
<a class="sourceLine" id="cb11-62" data-line-number="62">            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> pure <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb11-63" data-line-number="63">            <span class="dt">Just</span> (<span class="dt">User</span> user) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-64" data-line-number="64">              <span class="kw">let</span> user' <span class="fu">=</span> <span class="dt">User</span> (user { name <span class="fu">=</span> userName })</a>
<a class="sourceLine" id="cb11-65" data-line-number="65">              P.updateUser conn user'</a>
<a class="sourceLine" id="cb11-66" data-line-number="66">              pure <span class="fu">$</span> <span class="dt">Just</span> user'</a>
<a class="sourceLine" id="cb11-67" data-line-number="67">        <span class="kw">case</span> savedUser <span class="kw">of</span></a>
<a class="sourceLine" id="cb11-68" data-line-number="68">          <span class="dt">Nothing</span> <span class="ot">-&gt;</span> respond <span class="dv">404</span> { error<span class="fu">:</span> <span class="st">&quot;User not found with id: &quot;</span> <span class="fu">&lt;&gt;</span> show userId }</a>
<a class="sourceLine" id="cb11-69" data-line-number="69">          <span class="dt">Just</span> user <span class="ot">-&gt;</span> respond <span class="dv">200</span> (encode user)</a>
<a class="sourceLine" id="cb11-70" data-line-number="70">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb11-71" data-line-number="71">    getUserPatch <span class="fu">=</span> lift getBody <span class="fu">&gt;&gt;=</span> V.except <span class="fu">&lt;&lt;&lt;</span> renderForeignErrors</a>
<a class="sourceLine" id="cb11-72" data-line-number="72">    getUserName <span class="fu">=</span> V.exceptCond <span class="st">&quot;User name must not be empty&quot;</span> (_ <span class="fu">/=</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-73" data-line-number="73"></a>
<a class="sourceLine" id="cb11-74" data-line-number="74"><span class="ot">listUsers ::</span> forall eff<span class="fu">.</span> <span class="dt">PG.Pool</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> (<span class="ot">postgreSQL ::</span> <span class="dt">PG.POSTGRESQL</span> <span class="fu">|</span> eff)</a>
<a class="sourceLine" id="cb11-75" data-line-number="75">listUsers pool <span class="fu">=</span> liftAff (PG.withConnection pool P.listUsers) <span class="fu">&gt;&gt;=</span> encode <span class="fu">&gt;&gt;&gt;</span> respond <span class="dv">200</span></a>
<a class="sourceLine" id="cb11-76" data-line-number="76"></a>
<a class="sourceLine" id="cb11-77" data-line-number="77"><span class="ot">getUserId ::</span> forall eff<span class="fu">.</span> <span class="dt">V.Validation</span> eff <span class="dt">Int</span></a>
<a class="sourceLine" id="cb11-78" data-line-number="78">getUserId <span class="fu">=</span> lift (getRouteParam <span class="st">&quot;id&quot;</span>)</a>
<a class="sourceLine" id="cb11-79" data-line-number="79">  <span class="fu">&gt;&gt;=</span> V.exceptMaybe <span class="st">&quot;User ID is required&quot;</span></a>
<a class="sourceLine" id="cb11-80" data-line-number="80">  <span class="fu">&gt;&gt;=</span> fromString <span class="fu">&gt;&gt;&gt;</span> V.exceptMaybe <span class="st">&quot;User ID must be an integer&quot;</span></a>
<a class="sourceLine" id="cb11-81" data-line-number="81">  <span class="fu">&gt;&gt;=</span> V.exceptCond <span class="st">&quot;User ID must be positive&quot;</span> (_ <span class="fu">&gt;</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb11-82" data-line-number="82"></a>
<a class="sourceLine" id="cb11-83" data-line-number="83"><span class="ot">renderForeignErrors ::</span> forall a<span class="fu">.</span> <span class="dt">Either</span> (<span class="dt">NonEmptyList</span> <span class="dt">ForeignError</span>) a <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">String</span> a</a>
<a class="sourceLine" id="cb11-84" data-line-number="84">renderForeignErrors <span class="fu">=</span> lmap (toList <span class="fu">&gt;&gt;&gt;</span> map renderForeignError <span class="fu">&gt;&gt;&gt;</span> intercalate <span class="st">&quot;, &quot;</span>)</a>
<a class="sourceLine" id="cb11-85" data-line-number="85"></a>
<a class="sourceLine" id="cb11-86" data-line-number="86"><span class="ot">respond ::</span> forall eff a<span class="fu">.</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Handler</span> eff</a>
<a class="sourceLine" id="cb11-87" data-line-number="87">respond status body <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-88" data-line-number="88">  setStatus status</a>
<a class="sourceLine" id="cb11-89" data-line-number="89">  sendJson body</a>
<a class="sourceLine" id="cb11-90" data-line-number="90"></a>
<a class="sourceLine" id="cb11-91" data-line-number="91"><span class="ot">respondNoContent ::</span> forall eff<span class="fu">.</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> eff</a>
<a class="sourceLine" id="cb11-92" data-line-number="92">respondNoContent status <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-93" data-line-number="93">  setStatus status</a>
<a class="sourceLine" id="cb11-94" data-line-number="94">  end</a></code></pre></div>


<p>The code is much cleaner now. Let’s try out a few test cases:</p>


<pre class="http"><code>$ http POST http://localhost:4000/v1/users id:=3 name=roger
HTTP/1.1 201 Created
Connection: keep-alive
Content-Length: 0
Date: Sat, 30 Sep 2017 12:13:37 GMT
X-Powered-By: Express</code></pre>


<pre class="http"><code>$ http POST http://localhost:4000/v1/users id:=3
HTTP/1.1 422 Unprocessable Entity
Connection: keep-alive
Content-Length: 102
Content-Type: application/json; charset=utf-8
Date: Sat, 30 Sep 2017 12:13:50 GMT
ETag: W/&quot;66-/c4cfoquQZGwtDBUzHjJydJAHJ0&quot;
X-Powered-By: Express

{
    &quot;error&quot;: &quot;Error at array index 0: (ErrorAtProperty \&quot;name\&quot; (TypeMismatch \&quot;String\&quot; \&quot;Undefined\&quot;))&quot;
}</code></pre>


<pre class="http"><code>$ http POST http://localhost:4000/v1/users id:=3 name=&quot;&quot;
HTTP/1.1 422 Unprocessable Entity
Connection: keep-alive
Content-Length: 39
Content-Type: application/json; charset=utf-8
Date: Sat, 30 Sep 2017 12:14:02 GMT
ETag: W/&quot;27-JQsh12xu/rEFdWy8REF4NMtBUB4&quot;
X-Powered-By: Express

{
    &quot;error&quot;: &quot;User name must not be empty&quot;
}</code></pre>


<pre class="http"><code>$ http POST http://localhost:4000/v1/users id:=0 name=roger
HTTP/1.1 422 Unprocessable Entity
Connection: keep-alive
Content-Length: 36
Content-Type: application/json; charset=utf-8
Date: Sat, 30 Sep 2017 12:14:14 GMT
ETag: W/&quot;24-Pvt1L4eGilBmVtaOGHlSReJ413E&quot;
X-Powered-By: Express

{
    &quot;error&quot;: &quot;User ID must be positive&quot;
}</code></pre>


<pre class="http"><code>$ http GET http://localhost:4000/v1/user/3
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 23
Content-Type: application/json; charset=utf-8
Date: Sat, 30 Sep 2017 12:14:28 GMT
ETag: W/&quot;17-1scpiB1FT9DBu9s4I1gNWSjH2go&quot;
X-Powered-By: Express

{
    &quot;id&quot;: 3,
    &quot;name&quot;: &quot;roger&quot;
}</code></pre>


<pre class="http"><code>$ http GET http://localhost:4000/v1/user/asdf
HTTP/1.1 422 Unprocessable Entity
Connection: keep-alive
Content-Length: 38
Content-Type: application/json; charset=utf-8
Date: Sat, 30 Sep 2017 12:14:40 GMT
ETag: W/&quot;26-//tvORl1gGDUMwgSaqbEpJhuadI&quot;
X-Powered-By: Express

{
    &quot;error&quot;: &quot;User ID must be an integer&quot;
}</code></pre>


<pre class="http"><code>$ http GET http://localhost:4000/v1/user/-1
HTTP/1.1 422 Unprocessable Entity
Connection: keep-alive
Content-Length: 36
Content-Type: application/json; charset=utf-8
Date: Sat, 30 Sep 2017 12:14:45 GMT
ETag: W/&quot;24-Pvt1L4eGilBmVtaOGHlSReJ413E&quot;
X-Powered-By: Express

{
    &quot;error&quot;: &quot;User ID must be positive&quot;
}</code></pre>


<p>It works as expected.</p>


<h2 id="configuration" data-track-content data-content-name="configuration" data-content-piece="ps-simple-rest-service-2">Configuration<a href="#configuration" class="ref-link"></a><a href="#top" class="top-link" title="Back to top"></a></h2>


<p>Right now our application configuration resides in the <code>main</code> function:</p>


<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb19-1" data-line-number="1">main <span class="fu">=</span> runServer port databaseConfig</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3">    port <span class="fu">=</span> <span class="dv">4000</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4">    databaseConfig <span class="fu">=</span> { user<span class="fu">:</span> <span class="st">&quot;abhinav&quot;</span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5">                     , password<span class="fu">:</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6">                     , host<span class="fu">:</span> <span class="st">&quot;localhost&quot;</span></a>
<a class="sourceLine" id="cb19-7" data-line-number="7">                     , port<span class="fu">:</span> <span class="dv">5432</span></a>
<a class="sourceLine" id="cb19-8" data-line-number="8">                     , database<span class="fu">:</span> <span class="st">&quot;simple_service&quot;</span></a>
<a class="sourceLine" id="cb19-9" data-line-number="9">                     , max<span class="fu">:</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb19-10" data-line-number="10">                     , idleTimeoutMillis<span class="fu">:</span> <span class="dv">1000</span></a>
<a class="sourceLine" id="cb19-11" data-line-number="11">                     }</a></code></pre></div>


<p>We are going to extract it out of the code and read it from the environment variables using the <a href="https://pursuit.purescript.org/packages/purescript-config" target="_blank" rel="noopener"><code>purescript-config</code></a> package. First, we install the required packages using <a href="http://bower.io" target="_blank" rel="noopener">bower</a>.</p>


<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb20-1" data-line-number="1">$ <span class="ex">bower</span> install --save purescript-node-process purescript-config</a></code></pre></div>


<p>Now, we write the following code in the <code>src/SimpleService/Config.purs</code> file:</p>


<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw">module</span> <span class="dt">SimpleService.Config</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb21-2" data-line-number="2"></a>
<a class="sourceLine" id="cb21-3" data-line-number="3"><span class="kw">import</span> <span class="dt">Data.Config</span></a>
<a class="sourceLine" id="cb21-4" data-line-number="4"><span class="kw">import</span> <span class="dt">Prelude</span></a>
<a class="sourceLine" id="cb21-5" data-line-number="5"></a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="kw">import</span> <span class="dt">Control.Monad.Eff</span> (<span class="dt">Eff</span>)</a>
<a class="sourceLine" id="cb21-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Data.Config.Node</span> (fromEnv)</a>
<a class="sourceLine" id="cb21-8" data-line-number="8"><span class="kw">import</span> <span class="dt">Data.Either</span> (<span class="dt">Either</span>)</a>
<a class="sourceLine" id="cb21-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Data.Set</span> (<span class="dt">Set</span>)</a>
<a class="sourceLine" id="cb21-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Database.PostgreSQL</span> <span class="kw">as</span> <span class="dt">PG</span></a>
<a class="sourceLine" id="cb21-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Node.Process</span> (<span class="dt">PROCESS</span>)</a>
<a class="sourceLine" id="cb21-12" data-line-number="12"></a>
<a class="sourceLine" id="cb21-13" data-line-number="13"><span class="kw">type</span> <span class="dt">ServerConfig</span> <span class="fu">=</span></a>
<a class="sourceLine" id="cb21-14" data-line-number="14">  {<span class="ot"> port           ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb21-15" data-line-number="15">  ,<span class="ot"> databaseConfig ::</span> <span class="dt">PG.PoolConfiguration</span></a>
<a class="sourceLine" id="cb21-16" data-line-number="16">  }</a>
<a class="sourceLine" id="cb21-17" data-line-number="17"></a>
<a class="sourceLine" id="cb21-18" data-line-number="18"><span class="ot">databaseConfig ::</span> <span class="dt">Config</span> {<span class="ot">name ::</span> <span class="dt">String</span>} <span class="dt">PG.PoolConfiguration</span></a>
<a class="sourceLine" id="cb21-19" data-line-number="19">databaseConfig <span class="fu">=</span></a>
<a class="sourceLine" id="cb21-20" data-line-number="20">  { user<span class="fu">:</span> _, password<span class="fu">:</span> _, host<span class="fu">:</span> _, port<span class="fu">:</span> _, database<span class="fu">:</span> _, max<span class="fu">:</span> _, idleTimeoutMillis<span class="fu">:</span> _ }</a>
<a class="sourceLine" id="cb21-21" data-line-number="21">  <span class="fu">&lt;$&gt;</span> string {name<span class="fu">:</span> <span class="st">&quot;user&quot;</span>}</a>
<a class="sourceLine" id="cb21-22" data-line-number="22">  <span class="fu">&lt;*&gt;</span> string {name<span class="fu">:</span> <span class="st">&quot;password&quot;</span>}</a>
<a class="sourceLine" id="cb21-23" data-line-number="23">  <span class="fu">&lt;*&gt;</span> string {name<span class="fu">:</span> <span class="st">&quot;host&quot;</span>}</a>
<a class="sourceLine" id="cb21-24" data-line-number="24">  <span class="fu">&lt;*&gt;</span> int    {name<span class="fu">:</span> <span class="st">&quot;port&quot;</span>}</a>
<a class="sourceLine" id="cb21-25" data-line-number="25">  <span class="fu">&lt;*&gt;</span> string {name<span class="fu">:</span> <span class="st">&quot;database&quot;</span>}</a>
<a class="sourceLine" id="cb21-26" data-line-number="26">  <span class="fu">&lt;*&gt;</span> int    {name<span class="fu">:</span> <span class="st">&quot;pool_size&quot;</span>}</a>
<a class="sourceLine" id="cb21-27" data-line-number="27">  <span class="fu">&lt;*&gt;</span> int    {name<span class="fu">:</span> <span class="st">&quot;idle_conn_timeout_millis&quot;</span>}</a>
<a class="sourceLine" id="cb21-28" data-line-number="28"></a>
<a class="sourceLine" id="cb21-29" data-line-number="29"><span class="ot">portConfig ::</span> <span class="dt">Config</span> {<span class="ot">name ::</span> <span class="dt">String</span>} <span class="dt">Int</span></a>
<a class="sourceLine" id="cb21-30" data-line-number="30">portConfig <span class="fu">=</span> int {name<span class="fu">:</span> <span class="st">&quot;port&quot;</span>}</a>
<a class="sourceLine" id="cb21-31" data-line-number="31"></a>
<a class="sourceLine" id="cb21-32" data-line-number="32"><span class="ot">serverConfig ::</span> <span class="dt">Config</span> {<span class="ot">name ::</span> <span class="dt">String</span>} <span class="dt">ServerConfig</span></a>
<a class="sourceLine" id="cb21-33" data-line-number="33">serverConfig <span class="fu">=</span></a>
<a class="sourceLine" id="cb21-34" data-line-number="34">  { port<span class="fu">:</span> _, databaseConfig<span class="fu">:</span> _}</a>
<a class="sourceLine" id="cb21-35" data-line-number="35">  <span class="fu">&lt;$&gt;</span> portConfig</a>
<a class="sourceLine" id="cb21-36" data-line-number="36">  <span class="fu">&lt;*&gt;</span> prefix {name<span class="fu">:</span> <span class="st">&quot;db&quot;</span>} databaseConfig</a>
<a class="sourceLine" id="cb21-37" data-line-number="37"></a>
<a class="sourceLine" id="cb21-38" data-line-number="38"><span class="ot">readServerConfig ::</span> forall eff<span class="fu">.</span></a>
<a class="sourceLine" id="cb21-39" data-line-number="39">                    <span class="dt">Eff</span> (<span class="ot">process ::</span> <span class="dt">PROCESS</span> <span class="fu">|</span> eff) (<span class="dt">Either</span> (<span class="dt">Set</span> <span class="dt">String</span>) <span class="dt">ServerConfig</span>)</a>
<a class="sourceLine" id="cb21-40" data-line-number="40">readServerConfig <span class="fu">=</span> fromEnv <span class="st">&quot;SS&quot;</span> serverConfig</a></code></pre></div>


<p>We use the applicative DSL provided in <code>Data.Config</code> module to build a description of our configuration. This description contains the keys and types of the configuration, for consumption by various interpreters. Then we use the <code>fromEnv</code> interpreter to read the config from the environment variables derived from the <code>name</code> fields in the records in the description in the <code>readServerConfig</code> function. We also write a bash script to set those environment variables in the development environment in the <code>setenv.sh</code> file:</p>


<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="bu">export</span> <span class="va">SS_PORT=</span>4000</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="bu">export</span> <span class="va">SS_DB_USER=</span><span class="st">&quot;abhinav&quot;</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="bu">export</span> <span class="va">SS_DB_PASSWORD=</span><span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="bu">export</span> <span class="va">SS_DB_HOST=</span><span class="st">&quot;localhost&quot;</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="bu">export</span> <span class="va">SS_DB_PORT=</span>5432</a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="bu">export</span> <span class="va">SS_DB_DATABASE=</span><span class="st">&quot;simple_service&quot;</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="bu">export</span> <span class="va">SS_DB_POOL_SIZE=</span>10</a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="bu">export</span> <span class="va">SS_DB_IDLE_CONN_TIMEOUT_MILLIS=</span>1000</a></code></pre></div>


<p>Now we rewrite our <code>src/Main.purs</code> file to use the <code>readServerConfig</code> function:</p>


<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"></a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="kw">import</span> <span class="dt">Prelude</span></a>
<a class="sourceLine" id="cb23-4" data-line-number="4"></a>
<a class="sourceLine" id="cb23-5" data-line-number="5"><span class="kw">import</span> <span class="dt">Control.Monad.Eff</span> (<span class="dt">Eff</span>)</a>
<a class="sourceLine" id="cb23-6" data-line-number="6"><span class="kw">import</span> <span class="dt">Control.Monad.Eff.Console</span> (<span class="dt">CONSOLE</span>, log)</a>
<a class="sourceLine" id="cb23-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Data.Either</span> (<span class="dt">Either</span>(..))</a>
<a class="sourceLine" id="cb23-8" data-line-number="8"><span class="kw">import</span> <span class="dt">Data.Set</span> (toUnfoldable)</a>
<a class="sourceLine" id="cb23-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Data.String</span> (joinWith)</a>
<a class="sourceLine" id="cb23-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Database.PostgreSQL</span> <span class="kw">as</span> <span class="dt">PG</span></a>
<a class="sourceLine" id="cb23-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Node.Express.Types</span> (<span class="dt">EXPRESS</span>)</a>
<a class="sourceLine" id="cb23-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Node.Process</span> (<span class="dt">PROCESS</span>)</a>
<a class="sourceLine" id="cb23-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Node.Process</span> <span class="kw">as</span> <span class="dt">Process</span></a>
<a class="sourceLine" id="cb23-14" data-line-number="14"><span class="kw">import</span> <span class="dt">SimpleService.Config</span> (readServerConfig)</a>
<a class="sourceLine" id="cb23-15" data-line-number="15"><span class="kw">import</span> <span class="dt">SimpleService.Server</span> (runServer)</a>
<a class="sourceLine" id="cb23-16" data-line-number="16"></a>
<a class="sourceLine" id="cb23-17" data-line-number="17"><span class="ot">main ::</span> forall eff<span class="fu">.</span> <span class="dt">Eff</span> (<span class="ot"> console ::</span> <span class="dt">CONSOLE</span></a>
<a class="sourceLine" id="cb23-18" data-line-number="18">                        ,<span class="ot"> express ::</span> <span class="dt">EXPRESS</span></a>
<a class="sourceLine" id="cb23-19" data-line-number="19">                        ,<span class="ot"> postgreSQL ::</span> <span class="dt">PG.POSTGRESQL</span></a>
<a class="sourceLine" id="cb23-20" data-line-number="20">                        ,<span class="ot"> process ::</span> <span class="dt">PROCESS</span></a>
<a class="sourceLine" id="cb23-21" data-line-number="21">                        <span class="fu">|</span> eff ) <span class="dt">Unit</span></a>
<a class="sourceLine" id="cb23-22" data-line-number="22">main <span class="fu">=</span> readServerConfig <span class="fu">&gt;&gt;=</span> <span class="kw">case</span> _ <span class="kw">of</span></a>
<a class="sourceLine" id="cb23-23" data-line-number="23">  <span class="dt">Left</span> missingKeys <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb23-24" data-line-number="24">    log <span class="fu">$</span> <span class="st">&quot;Unable to start. Missing Env keys: &quot;</span> <span class="fu">&lt;&gt;</span> joinWith <span class="st">&quot;, &quot;</span> (toUnfoldable missingKeys)</a>
<a class="sourceLine" id="cb23-25" data-line-number="25">    Process.exit <span class="dv">1</span></a>
<a class="sourceLine" id="cb23-26" data-line-number="26">  <span class="dt">Right</span> { port, databaseConfig } <span class="ot">-&gt;</span> runServer port databaseConfig</a></code></pre></div>


<p>If <code>readServerConfig</code> fails, we print the missing keys to the console and exit the process. Else we run the server with the read config.</p>


<p>To test this, we stop the server we ran in the beginning, source the config, and run it again:</p>


<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb24-1" data-line-number="1">$ <span class="ex">pulp</span> --watch run</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="ex">*</span> Building project in /Users/abhinav/ps-simple-rest-service</a>
<a class="sourceLine" id="cb24-3" data-line-number="3"><span class="ex">*</span> Build successful.</a>
<a class="sourceLine" id="cb24-4" data-line-number="4"><span class="ex">Server</span> listening on :4000</a>
<a class="sourceLine" id="cb24-5" data-line-number="5">^<span class="ex">C</span></a>
<a class="sourceLine" id="cb24-6" data-line-number="6">$ <span class="bu">source</span> setenv.sh</a>
<a class="sourceLine" id="cb24-7" data-line-number="7">$ <span class="ex">pulp</span> --watch run</a>
<a class="sourceLine" id="cb24-8" data-line-number="8"><span class="ex">*</span> Building project in /Users/abhinav/ps-simple-rest-service</a>
<a class="sourceLine" id="cb24-9" data-line-number="9"><span class="ex">*</span> Build successful.</a>
<a class="sourceLine" id="cb24-10" data-line-number="10"><span class="ex">Server</span> listening on :4000</a></code></pre></div>


<p>It works! We test the failure case by opening another terminal which does not have the environment variables set:</p>


<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb25-1" data-line-number="1">$ <span class="ex">pulp</span> run</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="ex">*</span> Building project in /Users/abhinav/ps-simple-rest-service</a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="ex">*</span> Build successful.</a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="ex">Unable</span> to start. Missing Env keys: SS_DB_DATABASE, SS_DB_HOST, SS_DB_IDLE_CONN_TIMEOUT_MILLIS, SS_DB_PASSWORD, SS_DB_POOL_SIZE, SS_DB_PORT, SS_DB_USER, SS_PORT</a>
<a class="sourceLine" id="cb25-5" data-line-number="5"><span class="ex">*</span> ERROR: Subcommand terminated with exit code 1</a></code></pre></div>


<p>Up next, we add logging to our application.</p>


<h2 id="logging" data-track-content data-content-name="logging" data-content-piece="ps-simple-rest-service-2">Logging<a href="#logging" class="ref-link"></a><a href="#top" class="top-link" title="Back to top"></a></h2>


<p>For logging, we use the <a href="https://pursuit.purescript.org/packages/purescript-logging" target="_blank" rel="noopener"><code>purescript-logging</code></a> package. We write a logger which logs to <code>stdout</code>; in the <code>src/SimpleService/Logger.purs</code> file:</p>


<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw">module</span> <span class="dt">SimpleService.Logger</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2">  ( debug</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">  , info</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">  , warn</a>
<a class="sourceLine" id="cb26-5" data-line-number="5">  , error</a>
<a class="sourceLine" id="cb26-6" data-line-number="6">  ) <span class="kw">where</span></a>
<a class="sourceLine" id="cb26-7" data-line-number="7"></a>
<a class="sourceLine" id="cb26-8" data-line-number="8"><span class="kw">import</span> <span class="dt">Prelude</span></a>
<a class="sourceLine" id="cb26-9" data-line-number="9"></a>
<a class="sourceLine" id="cb26-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Control.Logger</span> <span class="kw">as</span> <span class="dt">L</span></a>
<a class="sourceLine" id="cb26-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Control.Monad.Eff.Class</span> (class <span class="dt">MonadEff</span>, liftEff)</a>
<a class="sourceLine" id="cb26-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Control.Monad.Eff.Console</span> <span class="kw">as</span> <span class="dt">C</span></a>
<a class="sourceLine" id="cb26-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Control.Monad.Eff.Now</span> (<span class="dt">NOW</span>, now)</a>
<a class="sourceLine" id="cb26-14" data-line-number="14"><span class="kw">import</span> <span class="dt">Data.DateTime.Instant</span> (toDateTime)</a>
<a class="sourceLine" id="cb26-15" data-line-number="15"><span class="kw">import</span> <span class="dt">Data.Either</span> (fromRight)</a>
<a class="sourceLine" id="cb26-16" data-line-number="16"><span class="kw">import</span> <span class="dt">Data.Formatter.DateTime</span> (<span class="dt">Formatter</span>, format, parseFormatString)</a>
<a class="sourceLine" id="cb26-17" data-line-number="17"><span class="kw">import</span> <span class="dt">Data.Generic.Rep</span> (class <span class="dt">Generic</span>)</a>
<a class="sourceLine" id="cb26-18" data-line-number="18"><span class="kw">import</span> <span class="dt">Data.Generic.Rep.Show</span> (genericShow)</a>
<a class="sourceLine" id="cb26-19" data-line-number="19"><span class="kw">import</span> <span class="dt">Data.String</span> (toUpper)</a>
<a class="sourceLine" id="cb26-20" data-line-number="20"><span class="kw">import</span> <span class="dt">Partial.Unsafe</span> (unsafePartial)</a>
<a class="sourceLine" id="cb26-21" data-line-number="21"></a>
<a class="sourceLine" id="cb26-22" data-line-number="22"><span class="kw">data</span> <span class="dt">Level</span> <span class="fu">=</span> <span class="dt">Debug</span> <span class="fu">|</span> <span class="dt">Info</span> <span class="fu">|</span> <span class="dt">Warn</span> <span class="fu">|</span> <span class="dt">Error</span></a>
<a class="sourceLine" id="cb26-23" data-line-number="23"></a>
<a class="sourceLine" id="cb26-24" data-line-number="24">derive <span class="kw">instance</span><span class="ot"> eqLevel ::</span> <span class="dt">Eq</span> <span class="dt">Level</span></a>
<a class="sourceLine" id="cb26-25" data-line-number="25">derive <span class="kw">instance</span><span class="ot"> ordLevel ::</span> <span class="dt">Ord</span> <span class="dt">Level</span></a>
<a class="sourceLine" id="cb26-26" data-line-number="26">derive <span class="kw">instance</span><span class="ot"> genericLevel ::</span> <span class="dt">Generic</span> <span class="dt">Level</span> _</a>
<a class="sourceLine" id="cb26-27" data-line-number="27"></a>
<a class="sourceLine" id="cb26-28" data-line-number="28"><span class="kw">instance</span><span class="ot"> showLevel ::</span> <span class="dt">Show</span> <span class="dt">Level</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb26-29" data-line-number="29">  show <span class="fu">=</span> toUpper <span class="fu">&lt;&lt;&lt;</span> genericShow</a>
<a class="sourceLine" id="cb26-30" data-line-number="30"></a>
<a class="sourceLine" id="cb26-31" data-line-number="31"><span class="kw">type</span> <span class="dt">Entry</span> <span class="fu">=</span></a>
<a class="sourceLine" id="cb26-32" data-line-number="32">  {<span class="ot"> level   ::</span> <span class="dt">Level</span></a>
<a class="sourceLine" id="cb26-33" data-line-number="33">  ,<span class="ot"> message ::</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb26-34" data-line-number="34">  }</a>
<a class="sourceLine" id="cb26-35" data-line-number="35"></a>
<a class="sourceLine" id="cb26-36" data-line-number="36"><span class="ot">dtFormatter ::</span> <span class="dt">Formatter</span></a>
<a class="sourceLine" id="cb26-37" data-line-number="37">dtFormatter <span class="fu">=</span> unsafePartial <span class="fu">$</span> fromRight <span class="fu">$</span> parseFormatString <span class="st">&quot;YYYY-MM-DD HH:mm:ss.SSS&quot;</span></a>
<a class="sourceLine" id="cb26-38" data-line-number="38"></a>
<a class="sourceLine" id="cb26-39" data-line-number="39"><span class="ot">logger ::</span> forall m e<span class="fu">.</span> (</a>
<a class="sourceLine" id="cb26-40" data-line-number="40">          <span class="dt">MonadEff</span> (<span class="ot">console ::</span> <span class="dt">C.CONSOLE</span>,<span class="ot"> now ::</span> <span class="dt">NOW</span> <span class="fu">|</span> e) m) <span class="ot">=&gt;</span> <span class="dt">L.Logger</span> m <span class="dt">Entry</span></a>
<a class="sourceLine" id="cb26-41" data-line-number="41">logger <span class="fu">=</span> <span class="dt">L.Logger</span> <span class="fu">$</span> \{ level, message } <span class="ot">-&gt;</span> liftEff <span class="kw">do</span></a>
<a class="sourceLine" id="cb26-42" data-line-number="42">  time <span class="ot">&lt;-</span> toDateTime <span class="fu">&lt;$&gt;</span> now</a>
<a class="sourceLine" id="cb26-43" data-line-number="43">  C.log <span class="fu">$</span> <span class="st">&quot;[&quot;</span> <span class="fu">&lt;&gt;</span> format dtFormatter time <span class="fu">&lt;&gt;</span> <span class="st">&quot;] &quot;</span> <span class="fu">&lt;&gt;</span> show level <span class="fu">&lt;&gt;</span> <span class="st">&quot; &quot;</span> <span class="fu">&lt;&gt;</span> message</a>
<a class="sourceLine" id="cb26-44" data-line-number="44"></a>
<a class="sourceLine" id="cb26-45" data-line-number="45">log<span class="ot"> ::</span> forall m e<span class="fu">.</span></a>
<a class="sourceLine" id="cb26-46" data-line-number="46">        <span class="dt">MonadEff</span> (<span class="ot">console ::</span> <span class="dt">C.CONSOLE</span> ,<span class="ot"> now ::</span> <span class="dt">NOW</span> <span class="fu">|</span> e) m</a>
<a class="sourceLine" id="cb26-47" data-line-number="47">     <span class="ot">=&gt;</span> <span class="dt">Entry</span> <span class="ot">-&gt;</span> m <span class="dt">Unit</span></a>
<a class="sourceLine" id="cb26-48" data-line-number="48">log entry<span class="fu">@</span>{level} <span class="fu">=</span> L.log (L.cfilter (\e <span class="ot">-&gt;</span> e<span class="fu">.</span>level <span class="fu">==</span> level) logger) entry</a>
<a class="sourceLine" id="cb26-49" data-line-number="49"></a>
<a class="sourceLine" id="cb26-50" data-line-number="50"><span class="ot">debug ::</span> forall m e<span class="fu">.</span></a>
<a class="sourceLine" id="cb26-51" data-line-number="51">         <span class="dt">MonadEff</span> (<span class="ot">console ::</span> <span class="dt">C.CONSOLE</span> ,<span class="ot"> now ::</span> <span class="dt">NOW</span> <span class="fu">|</span> e) m <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> m <span class="dt">Unit</span></a>
<a class="sourceLine" id="cb26-52" data-line-number="52">debug message <span class="fu">=</span> log { level<span class="fu">:</span> <span class="dt">Debug</span>, message }</a>
<a class="sourceLine" id="cb26-53" data-line-number="53"></a>
<a class="sourceLine" id="cb26-54" data-line-number="54"><span class="ot">info ::</span> forall m e<span class="fu">.</span></a>
<a class="sourceLine" id="cb26-55" data-line-number="55">        <span class="dt">MonadEff</span> (<span class="ot">console ::</span> <span class="dt">C.CONSOLE</span> ,<span class="ot"> now ::</span> <span class="dt">NOW</span> <span class="fu">|</span> e) m <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> m <span class="dt">Unit</span></a>
<a class="sourceLine" id="cb26-56" data-line-number="56">info message <span class="fu">=</span> log { level<span class="fu">:</span> <span class="dt">Info</span>, message }</a>
<a class="sourceLine" id="cb26-57" data-line-number="57"></a>
<a class="sourceLine" id="cb26-58" data-line-number="58"><span class="ot">warn ::</span> forall m e<span class="fu">.</span></a>
<a class="sourceLine" id="cb26-59" data-line-number="59">        <span class="dt">MonadEff</span> (<span class="ot">console ::</span> <span class="dt">C.CONSOLE</span> ,<span class="ot"> now ::</span> <span class="dt">NOW</span> <span class="fu">|</span> e) m <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> m <span class="dt">Unit</span></a>
<a class="sourceLine" id="cb26-60" data-line-number="60">warn message <span class="fu">=</span> log { level<span class="fu">:</span> <span class="dt">Warn</span>, message }</a>
<a class="sourceLine" id="cb26-61" data-line-number="61"></a>
<a class="sourceLine" id="cb26-62" data-line-number="62">error<span class="ot"> ::</span> forall m e<span class="fu">.</span></a>
<a class="sourceLine" id="cb26-63" data-line-number="63">         <span class="dt">MonadEff</span> (<span class="ot">console ::</span> <span class="dt">C.CONSOLE</span> ,<span class="ot"> now ::</span> <span class="dt">NOW</span> <span class="fu">|</span> e) m <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> m <span class="dt">Unit</span></a>
<a class="sourceLine" id="cb26-64" data-line-number="64">error message <span class="fu">=</span> log { level<span class="fu">:</span> <span class="dt">Error</span>, message }</a></code></pre></div>


<p><code>purescript-logging</code> lets us define our own logging levels and loggers. We define four log levels, and a log entry type with the log level and the message. Then we write the logger which will print the log entry to <code>stdout</code> along with the current time as a well formatted string. We define convenience functions for each log level.</p>


<p>Before we proceed, let’s install the required dependencies.</p>


<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb27-1" data-line-number="1">$ <span class="ex">bower</span> install --save purescript-logging purescript-now purescript-formatters</a></code></pre></div>


<p>Now we add a request logger middleware to our server in the <code>src/SimpleService/Server.purs</code> file:</p>


<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="co">-- previous code</span></a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Control.Monad.Eff.Console</span> (<span class="dt">CONSOLE</span>)</a>
<a class="sourceLine" id="cb28-3" data-line-number="3"><span class="kw">import</span> <span class="dt">Control.Monad.Eff.Now</span> (<span class="dt">NOW</span>)</a>
<a class="sourceLine" id="cb28-4" data-line-number="4"><span class="kw">import</span> <span class="dt">Data.Maybe</span> (maybe)</a>
<a class="sourceLine" id="cb28-5" data-line-number="5"><span class="kw">import</span> <span class="dt">Data.String</span> (toUpper)</a>
<a class="sourceLine" id="cb28-6" data-line-number="6"><span class="kw">import</span> <span class="dt">Node.Express.App</span> (<span class="dt">App</span>, all, delete, get, http, listenHttp, post, use, useExternal, useOnError)</a>
<a class="sourceLine" id="cb28-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Node.Express.Handler</span> (<span class="dt">Handler</span>, next)</a>
<a class="sourceLine" id="cb28-8" data-line-number="8"><span class="kw">import</span> <span class="dt">Node.Express.Request</span> (getMethod, getPath)</a>
<a class="sourceLine" id="cb28-9" data-line-number="9"><span class="kw">import</span> <span class="dt">SimpleService.Logger</span> <span class="kw">as</span> <span class="dt">Log</span></a>
<a class="sourceLine" id="cb28-10" data-line-number="10"><span class="co">-- previous code</span></a>
<a class="sourceLine" id="cb28-11" data-line-number="11"></a>
<a class="sourceLine" id="cb28-12" data-line-number="12"><span class="ot">requestLogger ::</span> forall eff<span class="fu">.</span> <span class="dt">Handler</span> (<span class="ot">console ::</span> <span class="dt">CONSOLE</span>,<span class="ot"> now ::</span> <span class="dt">NOW</span> <span class="fu">|</span> eff)</a>
<a class="sourceLine" id="cb28-13" data-line-number="13">requestLogger <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb28-14" data-line-number="14">  method <span class="ot">&lt;-</span> getMethod</a>
<a class="sourceLine" id="cb28-15" data-line-number="15">  path   <span class="ot">&lt;-</span> getPath</a>
<a class="sourceLine" id="cb28-16" data-line-number="16">  Log.debug <span class="fu">$</span> <span class="st">&quot;HTTP: &quot;</span> <span class="fu">&lt;&gt;</span> maybe <span class="st">&quot;&quot;</span> id ((toUpper <span class="fu">&lt;&lt;&lt;</span> show) <span class="fu">&lt;$&gt;</span> method) <span class="fu">&lt;&gt;</span> <span class="st">&quot; &quot;</span> <span class="fu">&lt;&gt;</span> path</a>
<a class="sourceLine" id="cb28-17" data-line-number="17">  next</a>
<a class="sourceLine" id="cb28-18" data-line-number="18"></a>
<a class="sourceLine" id="cb28-19" data-line-number="19"><span class="ot">app ::</span> forall eff<span class="fu">.</span></a>
<a class="sourceLine" id="cb28-20" data-line-number="20">       <span class="dt">PG.Pool</span></a>
<a class="sourceLine" id="cb28-21" data-line-number="21">    <span class="ot">-&gt;</span> <span class="dt">App</span> (<span class="ot">postgreSQL ::</span> <span class="dt">PG.POSTGRESQL</span>,<span class="ot"> console ::</span> <span class="dt">CONSOLE</span>,<span class="ot"> now ::</span> <span class="dt">NOW</span> <span class="fu">|</span> eff)</a>
<a class="sourceLine" id="cb28-22" data-line-number="22">app pool <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb28-23" data-line-number="23">  useExternal jsonBodyParser</a>
<a class="sourceLine" id="cb28-24" data-line-number="24">  use requestLogger</a>
<a class="sourceLine" id="cb28-25" data-line-number="25">  <span class="co">-- previous code</span></a></code></pre></div>


<p>We also convert all our previous logging statements which used <code>Console.log</code> to use <code>SimpleService.Logger</code> and add logs in our handlers. We can see logging in effect by restarting the server and hitting it:</p>


<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb29-1" data-line-number="1">$ <span class="ex">pulp</span> --watch run</a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="ex">*</span> Building project in /Users/abhinav/ps-simple-rest-service</a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="ex">*</span> Build successful.</a>
<a class="sourceLine" id="cb29-4" data-line-number="4">[<span class="ex">2017-09-30</span> 16:02:41.634] INFO Server listening on :4000</a>
<a class="sourceLine" id="cb29-5" data-line-number="5">[<span class="ex">2017-09-30</span> 16:02:43.494] DEBUG HTTP: PATCH /v1/user/3</a>
<a class="sourceLine" id="cb29-6" data-line-number="6">[<span class="ex">2017-09-30</span> 16:02:43.517] DEBUG Updated user: 3</a>
<a class="sourceLine" id="cb29-7" data-line-number="7">[<span class="ex">2017-09-30</span> 16:03:46.615] DEBUG HTTP: DELETE /v1/user/3</a>
<a class="sourceLine" id="cb29-8" data-line-number="8">[<span class="ex">2017-09-30</span> 16:03:46.635] DEBUG Deleted user 3</a>
<a class="sourceLine" id="cb29-9" data-line-number="9">[<span class="ex">2017-09-30</span> 16:05:03.805] DEBUG HTTP: GET /v1/users</a></code></pre></div>


<h2 id="conclusion" data-track-content data-content-name="conclusion" data-content-piece="ps-simple-rest-service-2">Conclusion<a href="#conclusion" class="ref-link"></a><a href="#top" class="top-link" title="Back to top"></a></h2>


<p>In this tutorial we learned how to create a simple JSON REST web service written in PureScript with persistence, validation, configuration and logging. The complete code for this tutorial can be found in <a href="https://github.com/abhin4v/ps-simple-rest-service" target="_blank" rel="noopener">github</a>. This post can be discussed on <a href="https://www.reddit.com/r/purescript/comments/73gc9g/writing_a_simple_rest_service_in_purescript_part/" target="_blank" rel="noopener">r/purescript</a>.</p>


<p>If you liked this post, please <a href="https://abhinavsarkar.net/posts/ps-simple-rest-service-2/#comment-container">leave a comment</a>.</p>


<p><img src="https://anna.abhinavsarkar.net/piwik.php?idsite=1&amp;rec=1" style="border:0; display: none;" /><div class="author">
  <img src="https://nilenso.com/images/people/abhinav-200.png" style="width: 96px; height: 96;">
  <span style="position: absolute; padding: 32px 15px;">
    <i>Original post by <a href="http://twitter.com/abhin4v">Abhinav Sarkar</a> - check out <a href="https://abhinavsarkar.net">All posts on abhinavsarkar.net</a></i>
  </span>
</div></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>A little something about me.</p>
</section>
Included file 'custom/asides/subscribe.html' not found in _includes directory<section>
  <h1>Popular Posts</h1>
  <ul id="recent_posts">
    
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/08/13/fast-sudoku-solver-in-haskell-3-picking-the-right/">Fast Sudoku Solver in Haskell #3: Picking the Right Data Structures</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/07/11/fast-sudoku-solver-in-haskell-2-a-200x-faster-sol/">Fast Sudoku Solver in Haskell #2: A 200x Faster Solution</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/06/28/fast-sudoku-solver-in-haskell-1-a-simple-solution/">Fast Sudoku Solver in Haskell #1: A Simple Solution</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/05/23/finances-in-an-employee-owned-technology-co-opera/">Finances in an Employee-Owned Technology Co-operative</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/04/09/designing-for-open-source-software/">Designing for Open Source Software</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/nilenso">@nilenso</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'nilenso',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section id="twitter">
  <h1 class="tweets">Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("nilenso", , );
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <p>Follow <a href="http://twitter.com/nilenso">@nilenso</a></p>
  
</section>





  
</aside>

    </div>
  </div>
  <div class="sidebar">
    <p class="sidebar-content">
      <a href="http://nilenso.com">nilenso</a> is an employee-owned software cooperative based out of Bangalore, India.
    </p>
    <p class="sidebar-content">
      We practice test driven development and continuous delivery, and love working with Clojure and Ruby on Rails.
    </p>
    <p class="sidebar-content">
      This blog is a showcase of our growth as a consultancy, a product company and generally curious beings.
      Get in touch with us at <a href="mailto:hello@nilenso.com">hello@nilenso.com</a>.
    </p>
  </div>
</body>
<div class="footer">
  <div class="section-content contact-info">
    <p class="contact-phone-number">
      <a class="contact-link email-link" href="mailto:hello@nilenso.com">hello@nilenso.com</a>
      <a class="contact-link contact-social-link" href="http://twitter.com/nilenso">@nilenso</a>
      <a class="contact-link contact-social-link" href="http://github.com/nilenso">github.com/nilenso</a>
      <a class="contact-link" href="tel:+918040937123">+91 80 4093 7123</a>
     </p>
    <p class="contact-address">Nilenso Software LLP, #105, 10th Cross, Indiranagar Stage 1, Bangalore, India, 560038</p>
  </div>
</div>









  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</html>
